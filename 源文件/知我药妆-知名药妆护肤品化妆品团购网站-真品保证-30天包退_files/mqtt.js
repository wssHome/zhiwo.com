
/* @file mqtt.im.js
 * @date 2018.03.06 15:08:26 
 */
(function($,undefined){var CON_UID="ntguest";var CON_PWD="xiaoneng123";$.IMConnection={name:"IMConnection",debug:false,client:null,mqttMessageTopic:"",mqttWillTopic:"",chatRouteTopic:"",sessionId:"",_urlExp:/(wss?:)\/\/(.*?):(\d+)\/(\w+)/gi,_ssl:false,_mqttserver:"",_clientId:"",_protocol:"",_host:"",_port:80,_path:"",_options:"",_conn:false,_reconnectCount:0,_waitTime:0,_timeout:6,_keepAliveInterval:60,eventCallback:{onConnectSuccess:{},onConnectFailure:{},onResponse:{},onPublish:{}},connect:function(url,clientId){this._conn=true;if(!this.client||!this.client.isConnected()){return this._connectMqtt(url,clientId)}else{this._fireEvent("onConnectSuccess",this.mqttMessageTopic)}return true},disconnect:function(){this._conn=false;if(this.client&&this.client.isConnected()){this._disconnectMqtt()}},publish:function(jsonMessage,topic){var strMessage,objMessage;if(!this.client||!this.client.isConnected()){if(this.debug){$.Log(this._clientId+" publish failure, client disconnect",3)}return false}if(!jsonMessage||typeof jsonMessage!=="object"){if(this.debug){$.Log(this._clientId+" publish param jsonMessage failure",3)}return false}strMessage=$.JSON.toJSONString(jsonMessage);topic=topic||this.chatRouteTopic;if(!topic){if(this.debug){$.Log(this._clientId+" publish param topic is null>"+strMessage)}return false}objMessage=this._mqttMessage(strMessage,topic);if(this.debug){$.Log(this._clientId+" $.IMConnection.publish("+strMessage+", "+topic+")",2)}return this.client.send(objMessage)},register:function(appId,eventName,callback){var arr,method,registered=false;var self=this;if(typeof callback==="function"){if(typeof this.eventCallback[eventName]==="undefined"){this.eventCallback[eventName]={}}$.each(this.eventCallback[eventName],function(key,func){if(func===callback||appId===key){registered=true}});if(registered!==true){if(this.debug){$.Log(this._clientId+" $.IMConnection.reqister("+eventName+")")}this.eventCallback[eventName][appId]=callback}}else if(typeof callback==="string"){arr=methodName.split(".");mehtod=$;$.each(arr,function(i,value){mehtod=mehtod[value]});if(typeof this.eventCallback[key]==="undefined"){this.eventCallback[key]={}}$.each(this.eventCallback[eventName],function(key,func){if(func===mehtod||appId===key){registered=true}});if(registered!==true){if(this.debug){$.Log(this._clientId+" $.IMConnection.reqister("+methodName+")")}this.eventCallback[eventName][appId]=mehtod}}},unregister:function(appId){var self=this;$.each(this.eventCallback,function(methodName,methods){$.each(methods,function(key,func){if(key===appId){delete self.eventCallback[methodName][key]}})})},subscribe:function(topic,options){if(!this.client||!this.client.isConnected()){return false}if(this.debug){$.Log(this._clientId+" $.IMConnection.subscribe("+topic+")")}var self=this;options=$.extend({qos:1},options);this.client.subscribe(topic,options)},unsubscribe:function(topic){if(!this.client||!this.client.isConnected()||!topic){return false}if(this.debug){$.Log(this._clientId+" $.IMConnection.unsubscribe("+topic+")")}this.client.unsubscribe(topic)},onConnectionLost:function(response){var self=this;if(response.errorCode===0){return}if(this.debug){$.Log(this._clientId+" $.IMConnection.onConnectionLost() > "+response.errorMessage,3)}this._reconnectMqtt()},onPublish:function(message){var data,method;if(!this.client||!this.client.isConnected()){return false}if(this.debug){$.Log(this._clientId+" $.IMConnection.onPublish() > "+message.payloadString,2)}try{data=$.JSON.parseJSON(message.payloadString)}catch(e){data={};$.Log("$.IMConnection.onPublish(): "+e.message,3)}method=data.method||"";if(method==="loginResult"){}if(method==="responseServer"){this.responseServer.apply(this,Array.prototype.concat.call([message.destinationName],data.params))}else if(method){this._fireEvent("onPublish",Array.prototype.concat.call([message.destinationName,method],data.params))}},responseServer:function(topic,cTopic,cWillTopic,sTopic,sId){var self=this;this.subscribe(cWillTopic,{onSuccess:function(result){if(this.debug){$.Log(self._clientId+" $.IMConnection.subscribe()>"+$JSON.toJSONString(result),2)}},onFailure:function(error){if(this.debug){$.Log(self._clientId+" $.IMConnection.subscribe()>"+$JSON.toJSONString(error),3)}self._fireEvent("onConnectSuccess",self.mqttMessageTopic)}});this.subscribe(sTopic);this._fireEvent("onResponse",topic,cTopic,cWillTopic,sTopic,sId)},getRegisterMethod:function(){return this.eventCallback},_connectMqtt:function(url,clientId){var self=this;var mqttserver=url;if(!this._mqttserver||this._mqttserver!==mqttserver){mqttserver=mqttserver||this._mqttserver;if(!this._format(mqttserver)){return false}this.chatRouteTopic="S/ROUTE/"+this._path}if(!this._clientId||this._clientId!==clientId){this._clientId=clientId||this._clientId;if(!this._clientId){return false}this.mqttMessageTopic="C/"+this._clientId;this.mqttWillTopic="S/WILL/"+this._clientId}this._options={userName:CON_UID,password:CON_PWD,useSSL:this._ssl,timeout:this._timeout,keepAliveInterval:this._keepAliveInterval,cleanSession:false,willMessage:this._mqttMessage("{}"),mqttVersion:4,onSuccess:function(){self._success()},onFailure:function(e){self._failure(e)}};if($.browser.supportMqtt){if(!this.client){if(this.debug){$.Log("connect mqtt server",2)}this.client=new $.MQTT.Client(this._host,this._port,this._clientId);this.client.onConnectionLost=function(response){self.onConnectionLost(response)};this.client.onMessageArrived=function(message){self.onPublish(message)}}else{if(this.debug){$.Log("reconnect mqtt server",2)}}this.client.connect(this._options);if(this.debug){this.client.startTrace()}}else{this.client=$.MQTT.flashSock;this.client.onConnectionLost=function(response){self.onConnectionLost(response)};this.client.onMessageArrived=function(message){self.onPublish(message)};this.client.init(this._host,this._port,this._clientId,this._options)}},_reconnectMqtt:function(){if((!this.client||!this.client.isConnected())&&this._conn){var self=this;if(++this._reconnectCount<=3){this._waitTime=50}else{this._waitTime=+"034567890".charAt(Math.ceil(Math.random()*5))*1e3}if(this.debug){$.Log(this._clientId+" wait recontent mqtt:"+this._waitTime,3)}this._fireEvent("onConnectFailure",this.mqttMessageTopic);setTimeout(function(){self._connectMqtt(self._mqttserver,self._clientId)},this._waitTime)}},_disconnectMqtt:function(){var message=this._mqttMessage("{}");this.publish(message,this.mqttWillTopic);this.unsubscribe(this.mqttMessageTopic);if(this.client){if(this.debug){this.client.stopTrace()}this.client.disconnect();if(this.client.clear){this.client.clear()}}this.client=null},_format:function(mqttserver){var math,url;if(!mqttserver||mqttserver===""){return false}if($.isObject(mqttserver)){if($.browser.supportMqtt){if($.protocol==="http:"&&$.flashserver.usehttps==0){url=mqttserver.ws?mqttserver.ws:mqttserver.wss.replace(/^wss:/,"ws:")}else{url=mqttserver.wss?mqttserver.wss:mqttserver.ws.replace(/^ws:/,"wss:")}}else{url=mqttserver.tcp}}else{url=mqttserver}math=this._urlExp.exec(url);if(!math||!math.length){math=url.replace(/(wss?|tcp):\/\//gi,",$1,").replace(/:(\d+)/gi,",$1").replace(/\//gi,",").split(",");if(!math||!math.length){$.Log("url:"+url+", math:"+math,2)}}this._protocol=$.flashserver.usehttps==1?"wss:":math[1]||"ws:";this._ssl=this._protocol==="wss:";this._host=math[2];this._port=Number(math[3])||(this._ssl?443:80);this._path=math[4]||"mqtt";this._mqttserver=url;return true},_success:function(){if(this.debug){$.Log(this._clientId+" $.IMConnection connect success.")}this._reconnectCount=0;this.subscribe(this.mqttMessageTopic);this._fireEvent("onConnectSuccess",this.mqttMessageTopic)},_failure:function(e){if(this.debug){$.Log(this._clientId+" $.IMConnection connect failure.")}this._fireEvent("onConnectFailure",this.mqttMessageTopic);this._reconnectMqtt()},_fireEvent:function(){var me=this;var args=Array.prototype.slice.call(arguments);var method=args[0];var params=args.slice(1);$.each(this.eventCallback[method],function(key,func){if(method==="onResponse"){func.apply(me,params.slice(1))}else{func.apply(me,params)}})},_mqttMessage:function(strMessage,topic){var message=new $.MQTT.Message(strMessage);topic=topic||this.mqttWillTopic;message.qos=1;message.destinationName=topic;return message}};$(window).bind("unload",function(){$.IMConnection.disconnect()})})(nTalk);(function($,undefined){var CON_FLASH_DIV="nTalk-flash-element",CON_IM_ID="ntkf_flash_impresence",CON_IM_FIX="IM_",CON_DATA_FIX="JDATA_",CON_PCID_KEY="machineid",CON_CURRENT_PAGE=CON_IM_FIX+"CURRENT_PAGE",CON_CUREENT_CONNECT=CON_IM_FIX+"CUREENT_CONNECT",CON_PAGE_DATA=CON_IM_FIX+"SEND_CURRENT_PAGE_DATA",CON_STYLE_PUBLIC_CONTENT="margin:0;padding:0;border:none;float:none;font:normal normal normal 12px/160% Arial,SimSun;",CON_EXIST_PAGEARR=CON_IM_FIX+"EXIST_PAGEARR";$.IMConnection.Presence=$.Class.create();$.IMConnection.Presence.prototype={name:"Presence",debugLevel:2,options:null,connectParams:["userid","username","token","sessionid","nullparam","nullparam","nullparam","siteid","nullparam","nullparam","connectType","pcid","nullparam"],connect:null,debug:false,login:false,currentPage:null,_reCount:0,_waitTime:500,_currentConnected:false,_waitReconnectTimeID:null,_stopReconnect:false,_roomConnectTimeout:5e3,initialize:function(options){var self=this;this.options=$.extend({deviceType:$.browser.mobile?3:0,nullparam:""},$.whereGet(options,["siteid","settingid","cid","surl","u","n","s","r","ref","fsid","userlevel"],["siteid","settingid","pcid","serverurl","userid","username","sessionid","resourceurl","referrer","flashsessionid","userLevel"]));this.data=$.store;this._reCount=0;$.Log("IMConnection.Presence start");if(!this.options.pcid||this.options.pcid.length<=10){this.options.pcid=this.data.get(CON_PCID_KEY);if(!this.options.pcid||this.options.pcid.length<=10){this.options.pcid=$.base._createScriptPCID()}}try{this.data.set(CON_PCID_KEY,this.options.pcid)}catch(e){$.Log(e,3)}if(!this.options.userid){this.options.userid=$.base.userIdFix+this.options.pcid.substr(0,21)}this.clientId="IM_"+$.randomChar(20).toLowerCase();this._callback("fIM_presenceFlashReady",[this.options.userid,this.options.pcid]);var manageOptions={onInterval:function(timeout,manageData){self._onInterval.call(self,timeout,manageData)},onChanage:function(count,data){self._onChanage.call(self,count,data)}};this.manage=new $.pageManage(manageOptions);this.identid=this.manage.identid;this.currentPage=new $.CurrentPage(this.identid,this.manage);this.setPageFocus(true,$.title,$.url);var eduimmqttserver=$.server.eduimmqttserver.toString().split(";");this.eduimmqttserver={};for(var i=0;i<eduimmqttserver.length;i++){if(!eduimmqttserver[i])continue;if(eduimmqttserver[i].indexOf("ws:")>-1){this.eduimmqttserver.ws=eduimmqttserver[i]}else if(eduimmqttserver[i].indexOf("wss:")>-1){this.eduimmqttserver.wss=eduimmqttserver[i]}else if(eduimmqttserver[i].indexOf("tcp")>-1){this.eduimmqttserver.tcp=eduimmqttserver[i]}}var guestInfostr=localStorage.getItem("gustInfo");if(guestInfostr){var guestInfoJson=JSON.parse(guestInfostr)}else{var guestInfoJson=new Object}if(!(this.identid in guestInfoJson)){guestInfoJson[this.identid]={userid:this.options.userid,loginname:$.global.uname,userlevel:this.options.userLevel?this.options.userLevel:0,isvip:$.global.isvip,time:(new Date).getTime()};this.guestInfoJson=guestInfoJson;localStorage.setItem("gustInfo",JSON.stringify(guestInfoJson))}},loginConnect:function(){var self=this;if(this.debug)$.Log("im.loginConnect()",this.debugLevel);this._callback("fIM_updateUserStatus",[1,""]);this.connect=$.IMConnection;this.connect.register(this.options.settingId,"onConnectSuccess",function(){self.requestServer()});this.connect.register(this.options.settingId,"onConnectFailure",function(){self._onAbnormal.apply(self,arguments);$.Log("mqtt:abnormal")});this.connect.register(this.options.settingId,"onResponse",function(cTopic,cWillTopic,sTopic,settingId){self.roomConnect(cTopic,cWillTopic,sTopic,settingId)});this.connect.register(this.options.settingId,"onPublish",function(){self._onCallback.apply(self,arguments)});this.connect.connect(this.eduimmqttserver,this.clientId)},requestServer:function(){var self=this;if(this.connected){return false}$.Log("$.IMConnection.Presence.requestServer()",2);this.connected=true;this.options.targetId="";this.connect.publish({method:"requestServer",params:[this.options.userid,this.clientId,this.options.settingid,this.options.targetId,this.options.sessionid]},this.connect.chatRouteTopic);this._roomConnectTimeID=setTimeout(function(){self.reconnect(0)},this._roomConnectTimeout)},roomConnect:function(cTopic,cWillTopic,sTopic,settingId){var self=this;if(this.options.settingid!==settingId){return false}var jsonstr='{"pcid":'+this.options.pcid+',"loginname":"'+nTalk.global.uname+'","devicetype":"'+this.options.deviceType+'","userlevel":'+(this.options.userLevel?this.options.userLevel:0)+',"isvip":'+nTalk.global.isvip+"}";$.Log("$.IMConnection.Presence.roomConnect("+cTopic+", "+cWillTopic+", "+sTopic+", "+settingId+")",2);this.clientTopic=cTopic;this.clientWillTopic=cWillTopic;this.serverTopic=sTopic;this.deviceType=0;this.connect.publish({method:"roomConnect",params:[this.options.userid,this.options.siteid,this.options.pcid,this.options.settingid,"",this.options.username,jsonstr]},this.clientTopic)},stopReroomConnect:function(){clearTimeout(this._roomConnectTimeID);this._roomConnectTimeID=null},startKaliveConnect:function(){var self=this;this.stopKaliveConnect();this.kaliveTimeId=setInterval(function(){$.Log("$.IMConnection.Presence.kaliveConnect()",1);self.connect.publish({method:"remoteKeepAlive",params:[self.options.connectId,self.options.userid,self.options.siteid,self.options.pcid]},self.clientTopic)},1e4)},stopKaliveConnect:function(){clearInterval(this.kaliveTimeId);this.kaliveTimeId=null},reconnect:function(level){var self=this;this.connected=false;if(level===0){this.connect.unsubscribe(this.clientWillTopic);this.connect.unsubscribe(this.serverTopic);this.connect.unregister(this.options.settingId)}if(++this._reconnect_tchat_count<=3){this._waitTime=500}else{this._waitTime=+"034567890".charAt(Math.ceil(Math.random()*5))*1e3}this._waitReconnectTimeID=setTimeout(function(){$.Log("$.IMConnection.Presence.reconnect(): waitTime:"+self._waitTime,2);if(level==0){self.loginConnect()}else{self.roomConnect(self.clientTopic,self.clientWillTopic,self.serverTopic,self.options.settingid)}},this._waitTime)},disconnect:function(){$.Log("$.IMConnection.Presence.disconnect()");var ret=this.data.getAll();for(var k in ret){if(typeof ret[k]=="function")continue;if(k.indexOf(CON_DATA_FIX)>-1){this.data.remove(k)}}this.stopReroomConnect();this.stopKaliveConnect()},LoginResult:function(login,siteId,clientId){this.login=login;this.options.connectId=clientId;$.Log("$.IMConnection.Presence.LoginResult("+$.JSON.toJSONString(arguments)+")",2);this._callback("fIM_updateUserStatus",[this.login?2:0,""]);if(this.login){this.startKaliveConnect("call kalive")}else{this.reconnect("login relogin")}this.stopReroomConnect()},remoteNotifyChatWithGroup:function(srcuid,srcnick,srcicon,msg,chatsessionid){var json,message,protocol;if(!msg){if(this.debug)$.Log("message content is null",3);return}$.Log("$.IMConnection.Presence.remoteNotifyChatWithGroup("+$.JSON.toJSONString(arguments)+")",2);message=$.clearHtml(msg.substr(0,msg.indexOf("ntalker://")));protocol=msg.substr(msg.indexOf("ntalker://")+10);try{json=$.JSON.parseJSON(protocol)}catch(e){}isStorageSupported=function(){var supported=null;try{supported=window.localStorage}catch(e){$.Log("localStorage:"+e.message,3);return false}if(supported){var mod="test";try{if(localStorage.getItem(mod)!==null){localStorage.removeItem(mod)}localStorage.setItem(mod,mod);if(localStorage.getItem(mod)==mod){localStorage.removeItem(mod);return true}else{return false}}catch(e){$.Log("The browser localStorage is unavailable. "+e.message,3);return false}}};if(isStorageSupported()){this._sendMessage2CurrenPage(message+"ntalker://"+protocol)}else{this._callback("fIM_onPresenceReceiveSysMessage",[1,message+"ntalker://"+protocol])}},remoteNotifyReverseChat:function(srcuid,srcnick,srcicon,msg,inviteid){var json,message,protocol;if(!msg){if(this.debug)$.Log("message content is null",3);return}var message="msg="+msg+"&&inviteid="+inviteid;var inviteidobj=$.JSON.parseJSON(inviteid);var ReverseChatObj=$.JSON.parseJSON(msg);ReverseChatObj.ReverseChat=1;msg=$.JSON.toJSONString(ReverseChatObj);ReverseChatObj=null;$.Log("$.IMConnection.Presence.remoteNotifyReverseChat("+$.JSON.toJSONString(arguments)+")",2);try{json=$.JSON.parseJSON(protocol)}catch(e){}isStorageSupported=function(){var supported=null;try{supported=window.localStorage}catch(e){$.Log("localStorage:"+e.message,3);return false}if(supported){var mod="test";try{if(localStorage.getItem(mod)!==null){localStorage.removeItem(mod)}localStorage.setItem(mod,mod);if(localStorage.getItem(mod)==mod){localStorage.removeItem(mod);return true}else{return false}}catch(e){$.Log("The browser localStorage is unavailable. "+e.message,3);return false}}};if(isStorageSupported()){this._sendMessage2CurrenPage(message)}else{this._callback("fIM_onPresenceReceiveSysMessage",[1,message])}},remoteNotifyUserCode:function(args){$.Log("do remoteNotifyUserCode!!!")},remoteConfirmAddFriend:function(args){$.Log("do remoteConfirmAddFriend")},_handleResponse:function(methodName,methodParams){if(this[methodName]){this[methodName].apply(this,methodParams)}else{$.Log("The object of the method '"+methodName+"' does not exist",3)}},_callback:function(methodName,methodParams){if($.hasOwnProperty(methodName)){try{$[methodName].apply(this,methodParams)}catch(e){}}else{$.Log("nTalk."+methodName+"(...)",2)}},_onCallback:function(args){var self=this,method;if(this.debug)$.Log("$.Presence.onCallback(  )");if(!args.length){return}topic=args[0];method=args[1];if(topic===this.clientWillTopic&&method==="reconnect"){this.reconnect();return false}else if(topic!==this.serverTopic){return false}$.Log("$.Presence.onCallback("+method+")");if(method==="connectResult"){this.LoginResult.apply(self,args.slice(2))}else if(method==="remoteNotifyChatWithGroup"){this.remoteNotifyChatWithGroup.apply(self,args.slice(5))}else if(method==="remoteNotifyReverseChat"){this.remoteNotifyReverseChat.apply(self,args.slice(2))}else{this._handleResponse.call(self,method,args.slice(2))}},_onAbnormal:function(){var args=Array.prototype.slice.call(arguments);if(this.debug)$.Log("$.Presence.onAbnormal( "+args[0]+","+args[1]+","+args[2]+" )",3);this.reconnect("abnormal login")},_handleResponse:function(methodName,methodParams){if(this[methodName]){this[methodName].apply(this,methodParams)}else{$.Log("The object of the method '"+methodName+"' does not exist",3)}},_onInterval:function(timeout,m){var diff;this.currentConn=this.data.get(CON_CUREENT_CONNECT)||{identid:"",time:0};if(this.currentConn.identid&&this.currentConn.identid===this.identid){this.currentConn.time=$.getTime();this.data.set(CON_CUREENT_CONNECT,this.currentConn);this._fireEvent("update")}else{var exists;if($.isArray(m)){for(var i=0;i<m.length;i++){page=m[i];if(page&&page[this.currentConn.identid]){exists=true;this._currentConnected=true}}}if(this.currentConn.identid&&this.currentConn.identid!==this.identid&&!exists){this.currentConn.identid="";this._currentConnected=false;this._fireEvent("clear")}if(this.debug)$.Log("currentConnect>>_onInterval:"+$.JSON.toJSONString(this.currentConn)+", _currentConnected:"+this._currentConnected);if((!this.currentConn.identid||this.currentConn.identid==="")&&!this._currentConnected){this.currentConn={identid:this.identid,time:$.getTime()};this._currentConnected=true;try{this.data.set(CON_CUREENT_CONNECT,this.currentConn)}catch(e){$.Log(e,3)}this._fireEvent("add");this.loginConnect()}else{this._fireEvent("wait")}}if(this.connected){var guestInfostr=localStorage.getItem("gustInfo");if(guestInfostr){var guestInfoJson=JSON.parse(guestInfostr)}else{var guestInfoJson=new Object}for(var k in guestInfoJson){if(k==this.clientId){if(!(guestInfoJson[k].userid==this.options.userid&&guestInfoJson[k].loginname==nTalk.global.uname&&guestInfoJson[k].userlevel==(this.options.userLevel?this.options.userLevel:0))){this.options.userid=guestInfoJson[k].userid;$.global.name=guestInfoJson[k].loginname;this.options.userLevel=guestInfoJson[k].userLevel;this.options.isvip=guestInfoJson[k].isvip;this.reconnect(0)}localStorage.removeItem("gustInfo")}else{if(!(guestInfoJson[k].userid==this.options.userid&&guestInfoJson[k].loginname==nTalk.global.uname&&guestInfoJson[k].userlevel==(this.options.userLevel?this.options.userLevel:0))){this.options.userid=guestInfoJson[k].userid;this.options.loginname=guestInfoJson[k].loginname;this.options.userLevel=guestInfoJson[k].userLevel;this.reconnect(0)}localStorage.removeItem("gustInfo")}}}},_onChanage:function(pageCount,data){this.pageCount=pageCount;return},_fireEvent:function(type){if(this.temp==1||!this.temp){this.temp=1;if(this.debug&&type!=="wait"){$.Log(this.identid+", "+type+" long connect, curPage:"+this.currentPage.get(),2)}}else if(this.temp>=5)this.temp=0;this.temp++;this._currentGetMessage()},_toArray:function(json,arr){var result=[];if(!json){return"error"}for(var i=0;i<arr.length;i++){result.push(json[arr[i]]||"")}return result},_sendMessage2CurrenPage:function(message){var self=this,objectQueue,strdata=this.data.get(CON_PAGE_DATA);if(!message)return;if(!this.Queue){this.Queue=new $.Queue}if(strdata){this.Queue.enQueue({data:message})}else{this.data.set(CON_PAGE_DATA,message)}},_currentGetMessage:function(){var callCurrentPageData=this.data.get(CON_PAGE_DATA);if(!callCurrentPageData){return}try{callCurrentPageData=$.JSON.parseJSON(callCurrentPageData)}catch(e){}if(typeof document.hidden!=="undefined"){if(document.hidden==true){return}}else{if(!this.currentPage.get()||!callCurrentPageData){return}}this.data.remove(CON_PAGE_DATA);this._callback("fIM_onPresenceReceiveSysMessage",[1,callCurrentPageData]);if(!this.Queue){return}var objectQueue=this.Queue.deQueue();if(objectQueue){this._sendMessage2CurrenPage(objectQueue.data)}},setPageFocus:function(focus,title,url,other){if(focus===true){this.currentPage.set(title,url)}},closePresence:function(){if(this._wsFlag){this.connect.disconnect()}else{try{this.cometd.disconnect(true)}catch(e){}}this.data.remove(CON_CUREENT_CONNECT)},setJSData:function(){var ret,key,trailid=arguments[0];if(!trailid||trailid===""){ret=this.data.getAll();for(var k in ret){if(typeof ret[k]=="function")continue;if(k.indexOf(CON_DATA_FIX)>-1){this.data.remove(k)}}}else{key=CON_DATA_FIX+trailid+"-"+arguments[1];this.data.set(key,arguments[2])}},getJSData:function(){var ret,result={},key=Array.prototype.slice.call(arguments,0,2).slice(0,2).join("-");if(key&&arguments[1])return $.JSON.toJSONString(this.data.get(key));else{ret=this.data.getAll();for(var k in ret){if(typeof ret[k]=="function")continue;if(k.indexOf(CON_DATA_FIX)>-1){result[k]=ret[k]}}return $.JSON.toJSONString(result)}}}})(nTalk);