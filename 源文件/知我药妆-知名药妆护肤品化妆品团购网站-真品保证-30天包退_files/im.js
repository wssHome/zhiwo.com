
/* @file nt2.js
 * @date 2018.03.06 15:08:26 
 */
(function($,undefined){function emptyFunc(){}if($.animate){$.Log("nt2.js loaded");return}$.animate=function(){var style=document.documentElement.style;return style.webkitTransition!==undefined||style.MozTransition!==undefined||style.OTransition!==undefined||style.msTransition!==undefined||style.transition!==undefined}()?function(){var style=document.documentElement.style,prefix_name=style.webkitTransition!==undefined?"Webkit":style.MozTransition!==undefined?"Moz":style.OTransition!==undefined?"O":style.msTransition!==undefined?"ms":"",transition_name=prefix_name+"Transition";return function(elem,options,duration,callback){var css_value=[],css_name=[],unit=[],css_style=[],style=elem.style;duration=duration||300;$.each(options,function(name,item){css_name[name]=$.camelize(name);if($.isObject(item)){item.to=item.to||0;css_value[name]=!$.cssNumber[name]?parseInt(item.to,10):item.to;unit[name]=$.unit(name,item.to);if($.isDefined(item.from)){$.css(elem,css_name[name],parseInt(item.from,10)+unit[name])}}else{css_value[name]=$.cssNumber[name]?parseInt(item,10):item;unit[name]=$.unit(name,item);$.css(elem,css_name[name],css_value[name])}css_style.push(name)});setTimeout(function(){style[transition_name]="all "+duration+"ms";$.each(css_style,function(i,name){style[css_name[name]]=css_value[name]+unit[name]})},15);setTimeout(function(){style[transition_name]="";if(callback){callback.call(elem)}},duration);return elem}}():function(elem,options,duration,callback){var step=0,i=0,j,length=0,p=30,css_to_value=[],css_from_value=[],css_name=[],css_unit=[],css_style=[],property_value,timer;duration=duration||300;$.each(options,function(name,item){css_name.push($.camelize(name));if($.isObject(item)){property_value=item.to;if($.isDefined(item.from)){css_from_value.push(!$.cssNumber[name]?parseInt(item.from,10):item.from)}else{css_from_value.push(!$.cssNumber[name]?parseInt($(elem).css(name),10):$(elem).css(name))}$.css(elem,css_name[i],css_from_value[i]+$.unit(name,property_value))}else{property_value=item;css_from_value.push($(elem).css(name))}css_to_value.push($.cssNumber[name]?property_value:isNaN(parseInt(property_value,10))?"":parseInt(property_value,10));css_unit.push($.unit(name,property_value));i++;length++});for(j=0;j<p;j++){css_style[j]=[];for(i=0;i<length;i++){css_style[j][css_name[i]]=!$.cssNumber[css_name[i]]&&!$.isNumeric(parseInt(css_from_value[i]))?"":css_from_value[i]+(css_to_value[i]-css_from_value[i])/p*j+(css_name[i]==="opacity"?"":css_unit[i])}}var func=function(){for(i=0;i<length;i++){$.css(elem,css_name[i],css_style[step][css_name[i]])}step++};for(;i<p;i++){timer=setTimeout(func,duration/p*i)}setTimeout(function(){for(i=0;i<length;i++){$.css(elem,css_name[i],css_to_value[i]+css_unit[i])}if(callback){callback.call(elem)}},duration);return elem};$.extend({listenerFunctions:[],listenerMessage:function(bindFunc){var self=this;function funcMessage(event){$.each($.listenerFunctions,function(i,f){f.apply($,[event.data])})}$.listenerFunctions.push(bindFunc);if(!window.addEventListener||this.__listenerMessage===true){return}$.Event.addEvent(window,"message",funcMessage);$.removelistenerMessage=function(){$.Event.removeEvent(window,"message",funcMessage);$.listenerFunctions=[];self.__listenerMessage=false};this.__listenerMessage=true},postMessage:function(contentWindow,data,origin){if(!contentWindow.postMessage){return}origin=origin||"*";try{contentWindow.postMessage(data,origin)}catch(e){}}});$.Window=$.Class.create();$.Window.prototype={defaultOptions:{dropHeight:30,width:520,height:410,left:100,top:100,minWidth:520,minHeight:410,resize:false,drag:false,fixed:false,zIndex:1e6,rightNode:true,onChanage:emptyFunc,onClose:emptyFunc,onMinimize:emptyFunc,onMaximize:emptyFunc,onMaxResize:emptyFunc},_tmpMove:null,_tmpStop:null,containter:null,header:null,body:null,chatBody:null,rightElement:null,buttonResize:null,buttonClose:null,buttonMax:null,buttonMin:null,_x:0,_y:0,_isdrag:null,_Style:null,parent:null,initialize:function(options,parentElement){$.extend(this,this.defaultOptions,options);this.parent=parentElement||null;this.quirks=$.browser.msie6||$.browser.Quirks&&$.browser.oldmsie;this.right=$(window).width()-this.left-this.width;this.bottom=$(window).height()-this.top-this.height;$.Log("$.Window:: left:"+this.left+", top:"+this.top);this._create();this._bind()},close:function(event){this.cancelBubble(event);if(this.onClose.toString().indexOf("anonymous")<=-1){this.onClose()}else{this.containter.hide(function(){$(this).remove()})}},change:function(isCallback){if(isCallback)this.onChanage.call(this,{width:this.width,height:this.height});if(this._isdrag){return}this.chatBody.css({height:this.height-this.dropHeight+"px"});if(this.rightNode){this.rightElement.css("height",this.height-this.dropHeight+"px")}},maxresize:function(){this.onMaxResize()},minimize:function(event,hidden){if(hidden!==true){this.cancelBubble(event)}this.containter.css({height:"0px",width:"0px"});if(hidden!==true){this.onMinimize()}},maximize:function(event,hidden){this.containter.css({height:this.height+"px",width:this.width+"px"});if(hidden!==true){this.onMaximize()}},cancelBubble:function(event){this.containter.css("z-index",this.zIndex);$.Event.fixEvent(event).stopPropagation()},changeAttr:function(width,height){if(this.quirks){this.clearExpression()}$.extend(this,{width:width,height:height,left:Math.max(0,$(window).width()-this.right-width),top:Math.max(0,$(window).height()-this.bottom-height)});this.containter.css({width:this.width+"px",height:this.height+"px",left:this.left+"px",top:this.top+"px"});if(this.quirks){this.fixedPosition()}this.change(true)},start:function(event,isDrag){if(!isDrag){this.cancelBubble(event)}this._Style=isDrag?{x:"left",y:"top"}:{x:"width",y:"height"};this.right=$(window).width()-this.left-this.width;this.bottom=$(window).height()-this.top-this.height;if(this.quirks&&!isDrag){this.clearExpression()}event=$.Event.fixEvent(event);this.containter.css(isDrag?{"z-index":++this.zIndex}:{"z-index":++this.zIndex});this._isdrag=isDrag;this._x=isDrag?event.clientX-this.containter.get(0).offsetLeft||0:this.containter.get(0).offsetLeft||0;this._y=isDrag?event.clientY-this.containter.get(0).offsetTop||0:this.containter.get(0).offsetTop||0;if($.browser.msie){this.containter.bind("losecapture",this._tmpStop).get(0).setCapture()}else{$.Event.fixEvent(event).preventDefault();$(window).bind("blur",this._tmpStop)}$(document).bind("mousemove",this._tmpMove);$(document).bind("mouseup",this._tmpStop)},move:function(event){if(window.getSelection)window.getSelection().removeAllRanges();else document.selection.empty();event=$.Event.fixEvent(event);var i_x=event.clientX-this._x,i_y=event.clientY-this._y,offset=$(window).offset();if(this._isdrag){if(this.quirks){this[this._Style.x]=Math.min(Math.max(i_x,offset.left),offset.left+$(window).width()-this.width)-offset.left;this[this._Style.y]=Math.min(Math.max(i_y,offset.top),offset.top+$(window).height()-this.height)-offset.top}else{this[this._Style.x]=Math.min(Math.max(i_x,0),$(window).width()-this.width);this[this._Style.y]=Math.min(Math.max(i_y,0),$(window).height()-this.height)}this.containter.css(this._Style.x,(this.quirks?offset.left:0)+Math.max(0,this[this._Style.x])+"px");this.containter.css(this._Style.y,(this.quirks?offset.top:0)+Math.max(0,this[this._Style.y])+"px")}else{if(this.quirks){this[this._Style.x]=Math.min(Math.max(i_x+(this.quirks?offset.left:0),this.minWidth),$(window).width()-this.left);this[this._Style.y]=Math.min(Math.max(i_y+(this.quirks?offset.top:0),this.minHeight),$(window).height()-this.top)}else{this[this._Style.x]=Math.min(Math.max(i_x,this.minWidth),$(window).width()-this.left);this[this._Style.y]=Math.min(Math.max(i_y,this.minHeight),$(window).height()-this.top)}this.containter.css(this._Style.x,this[this._Style.x]+"px");this.containter.css(this._Style.y,this[this._Style.y]+"px")}this.right=$(window).width()-this.left-this.width;this.bottom=$(window).height()-this.top-this.height;this.change(true)},stop:function(){if(this.quirks){this.fixedPosition()}this.containter.css({"z-index":--this.zIndex});$(document).removeEvent("mousemove",this._tmpMove);$(document).removeEvent("mouseup",this._tmpStop);if($.browser.msie){this.containter.removeEvent("losecapture",this._tmpStop).get(0).releaseCapture()}else{$(window).removeEvent("blur",this._tmpStop)}},fixedPosition:function(){if(this.quirks){var scrollTop=$(window).scrollTop();$(window).scrollTop(scrollTop+1);this.containter.replaceIEcssText({left:"expression(eval(Math.max((document.documentElement.scrollLeft || document.body.scrollLeft), (document.documentElement.scrollLeft || document.body.scrollLeft) + (document.documentElement.clientWidth  || document.body.clientWidth ) - this.offsetWidth  - "+this.right+")))",top:"expression(eval(Math.max((document.documentElement.scrollTop  || document.body.scrollTop ), (document.documentElement.scrollTop  || document.body.scrollTop ) + (document.documentElement.clientHeight || document.body.clientHeight) - this.offsetHeight - "+this.bottom+")))"});$(window).scrollTop(scrollTop);$(window).scrollLeft(1)}else{this.containter.css({left:this.left+"px",top:this.top+"px"})}},clearExpression:function(){var offset=$(window).offset();this.containter.Expression("left","");this.containter.Expression("top","");this.containter.Expression("left","");this.containter.replaceIEcssText({left:offset.left+this.left+"px",top:offset.top+this.top+"px"})},_for_resize:function(){this.left=Math.max(0,$(window).width()-this.right-this.width);this.top=Math.max(0,$(window).height()-this.bottom-this.height);if(!this.quirks){this.containter.css({left:this.left+"px",top:this.top+"px"})}},_create:function(){this.containter=$({className:this.className||"ntalk-window-containter",style:$.STYLE_BODY+"box-sizing:content-box;overflow:hidden;"}).appendTo(this.parent,true).css({position:!this.fixed?"absolute":!this.quirks?"fixed":"absolute",border:"none",width:this.width+"px",height:this.height+"px",zIndex:this.zIndex});this.fixedPosition();this.header=$({className:"ntalk-window-head",style:$.STYLE_BODY+"cursor:move;position:relative;left:0;top:0;"}).appendTo(this.containter).css({width:"100%",height:this.dropHeight+"px"});this.buttonClose=$({className:"ntalk-button-close",style:$.STYLE_BODY+"width:20px;height:20px;cursor:pointer;position:static;float:right;position:relative;margin:2px 3px 0 0;line-height:20px;vertical-align:middle;background:none;"}).appendTo(this.header);this.buttonMax=$({className:"ntalk-button-maxresize",style:$.STYLE_BODY+"width:20px;height:20px;cursor:pointer;position:static;float:right;position:relative;margin:2px 3px 0 0;line-height:20px;vertical-align:middle;background:none;"}).appendTo(this.header);this.buttonMin=$({className:"ntalk-button-min",style:$.STYLE_BODY+"width:20px;height:20px;cursor:pointer;position:static;float:right;position:relative;margin:2px 3px 0 0;line-height:20px;vertical-align:middle;background:none;"}).appendTo(this.header);this.body=$({className:"ntalk-window-body",style:$.STYLE_BODY+"float:left;width:100%;"}).appendTo(this.containter);this.chatBody=$({className:"ntalk-chat-body",style:$.STYLE_BODY+"width:100%;position:relative;left:0;top:0;"}).appendTo(this.body);if(this.rightNode){this.rightElement=$({className:"ntalk-window-right",style:$.STYLE_BODY+"float:left;display:none;width:100%;"}).appendTo(this.containter)}if(this.resize){this.buttonResize=$({className:"window-resize",style:$.STYLE_BODY+"width:10px;height:10px;cursor:nw-resize;position:absolute;right:1px;bottom:1px;font-size:0;background:none;z-index:99;"}).appendTo(this.containter)}$({style:$.STYLE_BODY+"clear:both;"}).appendTo(this.containter);this.change();return this.containter},_bind:function(){var self=this;this.containter.bind("mousedown",function(event){if(!self.drag)return;self.start.call(self,event,true)});this.buttonClose.bind("mousedown",function(event){$.Event.fixEvent(event).stopPropagation();self.close.call(self,event)});this.buttonMax.bind("mousedown",function(event){$.Event.fixEvent(event).stopPropagation();self.maxresize.call(self,event)});this.buttonMin.bind("mousedown",function(event){$.Event.fixEvent(event).stopPropagation();self.minimize.call(self,event)});this.chatBody.bind("mousedown",function(event){self.cancelBubble.call(self,event)});if(this.rightNode)this.rightElement.bind("mousedown",function(event){self.cancelBubble.call(self,event)});if(this.resize)this.buttonResize.bind("mousedown",function(event){self.start.call(self,event,false)});if(this.fixed){$(window).bind("resize",function(){self._for_resize()})}this._tmpStop=function(event){self.stop.call(self,event)};this._tmpMove=function(event){self.move.call(self,event)}}};$.Queue=$.Class.create();$.Queue.prototype={list:null,length:0,initialize:function(){this.list=[];this.length=this.list.length},isEmpty:function(){return this.list.length===0},enQueue:function(item){this.list.push(item);this.length=this.list.length;return this.list[this.length-1]},deQueue:function(){var tmp;if(this.isEmpty()){return null}tmp=this.list.shift();this.length=this.list.length;return tmp},queueFront:function(){return this.isEmpty()?null:this.list[0]}};$.pageManage=$.Class.create();$.pageManage.prototype={identid:"",keyid:"",data:null,interID:null,options:null,debug:false,inter:.8,count:0,chanageCall:true,CON_MANAGE_PAGE_LIST:"IM_EXIST_PAGEARR",pageStore:null,initialize:function(options,siteid){var self=this,arrPageList,cookiePageList,LSReadCount=3;if(this.debug){$.Log("pageManage.initialize():")}this.options=$.extend(this.options,{onChanage:emptyFunc,onInterval:emptyFunc,pageNum:3,timeout:2.5,inter:.8},options);this.keyid=$.CON_MANAGE_COOKIE+(siteid?"_"+siteid.toUpperCase():"");this.identid=this._2shortTime(0,8,13);if($.browser.chrome){this.options.timeout=5}this.options.timeout*=10;this.options.inter*=1e3;this.inter=this.options.inter;this.pageStore=$.store;try{while(LSReadCount--){arrPageList=this.pageStore.get(this.CON_MANAGE_PAGE_LIST)||"";if(arrPageList!=="")break}cookiePageList=this._get().m;arrPageList=arrPageList===""||cookiePageList.length===0?[]:arrPageList.split(",");if(arrPageList.length!=cookiePageList.length&&arrPageList.length<=this.options.pageNum){arrPageList=[];for(var i=0;i<cookiePageList.length;i++){for(var cookiePageId in cookiePageList[i]){arrPageList.push(cookiePageId)}}}arrPageList.push(this.identid);this.pageStore.set(this.CON_MANAGE_PAGE_LIST,arrPageList.join(","))}catch(e){}var before=$.getTime();this.interID=setInterval(function(){setTimeout(function(){now=$.getTime();var elapsedTime=now-before;self._update(elapsedTime);self.options.onInterval(self.options.timeout,self.data.m);before=$.getTime()},0)},this.options.inter);$.Event.addEvent(window,"unload",function(){self._remove();setTimeout(function(){},500)})},getIsLastPage:function(){return this.data.m.length},_get:function(){var data=$.cookie.get(this.keyid)||"{}";return $.extend({m:[]},$.JSON.parseJSON(data))},_save:function(){var data=$.JSON.toJSONString(this.data);$.cookie.set(this.keyid,data,0);return data},_remove:function(){var index=this._getIndex();this.data.m.splice(index,1);this._save();var pageStr=this.pageStore.get(this.CON_MANAGE_PAGE_LIST);if(!pageStr||pageStr===""){return}var pageArr=pageStr.split(",");for(var i=0;i<pageArr.length;i++){if(pageArr[i]==this.identid){pageArr.splice(i,1);break}}pageStr=pageArr.join(",");if(pageStr!==""){this.pageStore.set(this.CON_MANAGE_PAGE_LIST,pageStr)}else{this.pageStore.whereClear(this.CON_MANAGE_PAGE_LIST)}},_update:function(intervalTime){this.data=this._get();this._clear(intervalTime);var self=this,type="update",Index=this._getIndex();this.data.t=$.formatDate();if(!this.data.m[Index]){if(this.data.m.length<this.options.pageNum){type="add";this.data.m[Index]={}}else{return}}this.data.m[Index][this.identid]=this._2shortTime();this._save();if(this.debug){$.Log(this.identid+",pageCount:"+this.data.m.length+","+type+" data:"+$.JSON.toJSONString(this.data.m))}if((type=="add"||this.chanageCall!==true)&&this.count!=this.data.m.length){this.options.onChanage.call(this,this.data.m.length,this.data.m);this.count=this.data.m.length}this.chanageCall=false},_clear:function(intervalTime){var curTime=this._2shortTime();if(!this.data.m.length)return;for(var i=0,diff;i<this.data.m.length;i++){if(!this.data.m[i]){continue}for(var pid in this.data.m[i]){if(typeof this.data.m[i][pid]=="function"){continue}diff=curTime-this.data.m[i][pid];if(Math.abs(diff)>this.options.timeout+intervalTime/100){this.data.m.splice(i,1);this.chanageCall=true;var pageStr=this.pageStore.get(this.CON_MANAGE_PAGE_LIST);if(!pageStr||pageStr===""){return}var pageArr=pageStr.split(",");for(var j=0;j<pageArr.length;j++){if(pageArr[j]==pid){pageArr.splice(j,1);break}}pageStr=pageArr.join(",");if(pageStr!==""){this.pageStore.set(this.CON_MANAGE_PAGE_LIST,pageStr)}else{this.pageStore.whereClear(this.CON_MANAGE_PAGE_LIST)}}}}},_getIndex:function(){if(!this.data||!this.data.m.length){return 0}for(var i=0;i<this.data.m.length;i++){if(!this.data.m[i]){continue}for(var pid in this.data.m[i]){if(!this.data.m[i]||$.isFunction(this.data.m[i][pid])){continue}else if(pid===this.identid){return i}}}return i},_2shortTime:function(id,start,end){var identid=(id?id:$.getTime()).toString();start=start||5;end=end||11;return identid.substring(start,end)}};$.store=function(){var namespace="__cometd__",store={disabled:false},isStorageSupported=function(){var supported=null;try{supported=window.localStorage}catch(e){$.Log("localStorage:"+e.message,3);return false}if(supported){var mod="test";try{if(localStorage.getItem(mod)!==null){localStorage.removeItem(mod)}localStorage.setItem(mod,mod);if(localStorage.getItem(mod)==mod){localStorage.removeItem(mod);return true}else{return false}}catch(e){$.Log("The browser localStorage is unavailable. "+e.message,3);return false}}},isSupportUserData=$.browser.msie,storage;store.toJSONString=function(value){return value===null?"":$.JSON.toJSONString(value)};store.parseJSON=function(value){if(typeof value=="object"){return value||undefined}try{return $.JSON.parseJSON(value)}catch(e){return value||undefined}};if(isStorageSupported()){storage=window.localStorage;store.set=function(key,val){if(!val||val===undefined||val===null){return store.remove(key)}try{if(typeof storage.setItem=="function"){storage.setItem(key,store.toJSONString(val))}else{storage[key]=store.toJSONString(val)}}catch(e){if(e.name.toUpperCase()=="QUOTA_EXCEEDED_ERR"){store.remove(key);try{storage.setItem(key,store.toJSONString(val))}catch(err){$.Log("store.set:"+err.message,3)}}}return val};store.get=function(key){return store.parseJSON(storage.getItem(key))};store.remove=function(key){try{storage.removeItem(key)}catch(e){$.Log("store.remove:"+e.message,3)}};store.clear=function(){try{storage.clear()}catch(e){$.Log("store.clear:"+e.message,3)}};store.getAll=function(){var ret={};for(var i=0;i<storage.length;++i){var key=storage.key(i);ret[key]=store.get(key)}return ret}}else if(isSupportUserData){var forbiddenCharsRegex=new RegExp("[!\"#$%&'()*+,/\\\\:;<=>?@[\\]^`{|}~]","g");var storageOwner,storageContainer;var withIEStorage=function(storeFunction){return function(){var result,args=Array.prototype.slice.call(arguments,0);args.unshift(storage);try{storageOwner.appendChild(storage)}catch(e){storageOwner.insertBefore(storage,storageOwner.firstChild)}if(storage.addBehavior){storage.addBehavior("#default#userData")}var i=20;while(i>0){i--;try{storage.load("nTK-LS");break}catch(e){}}result=storeFunction.apply(store,args);storageOwner.removeChild(storage);return result}},ieKeyFix=function(key){return key.replace(forbiddenCharsRegex,"___")};try{storageContainer=new ActiveXObject("htmlfile");storageContainer.open();storageContainer.write('<script type="text/javascript">document.w=window;</script><iframe src="/favicon.ico"></iframe>');storageContainer.close();storageOwner=storageContainer.w.frames[0].document;storage=storageOwner.createElement("div")}catch(e){storage=document.createElement("div");storageOwner=document.body||document.getElementsByTagName("head")[0]||document.documentElement}store.set=withIEStorage(function(storage,key,val){key=ieKeyFix(key);if(!val||val===undefined||val===null){return store.remove(key)}storage.setAttribute(key,store.toJSONString(val));try{storage.save("nTK-LS")}catch(e){}return val});store.get=withIEStorage(function(storage,key){key=ieKeyFix(key);return store.parseJSON(storage.getAttribute(key))});store.remove=withIEStorage(function(storage,key){key=ieKeyFix(key);storage.removeAttribute(key);storage.save("nTK-LS")});store.clear=withIEStorage(function(storage){var attributes;try{attributes=storage.XMLDocument.documentElement.attributes}catch(e){return}storage.load("nTK-LS");for(var i=0,l=attributes.length;i<l;i++){var attr=attributes[i];storage.removeAttribute(attr.name)}storage.save("nTK-LS")});store.getAll=withIEStorage(function(storage){var attributes;try{attributes=storage.XMLDocument.documentElement.attributes}catch(e){return}var ret={};for(var i=0,l=attributes.length;i<l;++i){var attr=attributes[i];var key=ieKeyFix(attr.name);ret[attr.name]=store.parseJSON(storage.getAttribute(key))}return ret})}else{store.set=function(){$.Log("The browser localStorage is unavailable.",3)};store.get=emptyFunc;store.remove=emptyFunc;store.clear=emptyFunc;store.getAll=emptyFunc}try{store.set(namespace,namespace);if(store.get(namespace)!=namespace){store.disabled=true}store.remove(namespace)}catch(e){store.disabled=true}store.whereClear=function(fix){var self=this;var data=this.getAll();$.each(data,function(key){if(key.indexOf(fix)>-1){self.remove(key)}})};store.enabled=!store.disabled;return store}();$.comet=$.Class.create();$.comet.prototype={name:"public.comet",version:"2014.05.17",connType:"login",options:null,fix:"",id:"",count:0,sendIntervalID:null,_ipExpr:/^https?:\/\/\d+\.\d+\.\d+\.\d+(:\d+)?\/(.*?)$/gi,_cacheElement:{},_connectTimeID:{},defaultOption:{muDomain:1,timeout:20,onCallback:emptyFunc,onComplete:emptyFunc,onAbnormal:emptyFunc,onTimeout:emptyFunc},changePort:false,initialize:function(url,options){var self=this;this.uri=url;this.fix=$.randomChar();if(!this.uri){$.Log("comet uri is null",3)}this.callMethod=window;this.callbackName="callback_"+this.fix;this.callMethod[this.callbackName]=function(){self._connectCallback.call(self,self.id,arguments)};this.options=$.extend({},this.defaultOption,options);this.initConnectionPooling()},initMessageQueue:function(){if(!this.messageQueue){this.messageQueue=new $.Queue;this.messageQueue.addMessage=function(obj){for(var i=0;i<this.length;i++){if(this.list[i].msgid==obj.msgid&&this.list[i].index==obj.index){return false}}this.enQueue(obj);return true};this.messageQueue.nextMessage=function(msgid,index){if(this.isEmpty()){return null}else if(!msgid){return this.queueFront()}for(var i=0;i<this.length;i++){if(this.list[i].msgid==msgid&&this.list[i].body.sendpacket==index){return this.list[i+1]}}};this.messageQueue.removeMessage=function(msgid,index){for(var removeIndex,i=0;i<this.length;i++){if(this.list[i].msgid==msgid&&(this.list[i].index==index||index==-1)){removeIndex=i}}this.list.splice(i,1);this.length=this.list.length}}},initConnectionPooling:function(){if(!this.connectionPooling){if(this._ipExpr.test(this.uri)){this.options.muDomain=1}this.connectionPooling=new $.Queue;this.connectionPooling.get=function(){var cpConnect,unlockConnect,earliestConnect;for(var sTimesample,i=0;i<this.list.length;i++){if(this.list[i].lock===false){if(!unlockConnect||unlockConnect.rTimesample>this.list[i].rTimesample){unlockConnect=this.list[i]}}if(!earliestConnect||this.list[i].sTimesample<earliestConnect.sTimesample){earliestConnect=this.list[i]}}cpConnect=unlockConnect||earliestConnect;this.recover(cpConnect.uri,true);return cpConnect};this.connectionPooling.getConnect=function(){var cpConnect=this.get();return{uri:cpConnect.uri,url:cpConnect.uri+(/\?$/gi.test(cpConnect.uri)?"&":"?")}};this.connectionPooling.recover=function(uri,lock,sTimesample,rTimesample){for(var i=0;i<this.list.length;i++){if(this.list[i].uri!=uri)continue;this.list[i].lock=lock;if(lock){this.list[i].sTimesample=sTimesample||$.getTime();this.list[i].rTimesample=0}else{this.list[i].rTimesample=rTimesample||$.getTime()}return true}return false};for(var i=0;i<=this.options.muDomain;i++){var httpFlag=true;var usePort=false;var defaultPort=80;if(this.uri.indexOf("https://")>-1){httpFlag=false;defaultPort=443}var getPortUrl=this.uri.replace(/(https?:)(\/)+/gi,"");if(getPortUrl.indexOf(":")>-1&&getPortUrl.indexOf(":")<getPortUrl.indexOf("/")){usePort=true;defaultPort=parseInt(getPortUrl.substring(getPortUrl.indexOf(":")+1,getPortUrl.indexOf("/")))}if(i===1&&this.changePort){if(!usePort){this.uri=(httpFlag?"http://":"https://")+getPortUrl.replace("/",":"+ ++defaultPort+"/")}else{this.uri=(httpFlag?"http://":"https://")+getPortUrl.replace(":"+defaultPort,":"+ ++defaultPort)}}this.connectionPooling.enQueue({uri:this.uri.toString(),lock:false,sTimesample:0,rTimesample:0})}}},connect:function(json,callName){var objConnect,url,index=this.count++;this.connType="login";this.id=this.fix+"_"+index;json[callName||"callbackname"]=this.callbackName;this.connectOptions=$.extend(json,{ts:$.getTime()});objConnect=this.connectionPooling.getConnect();url=objConnect.url+$.toURI(this.connectOptions);this._cacheElement[this.id]=this._createConnect(url,this.id,index,objConnect)},kalive:function(json,callName){var objConnect,url,index=this.count++;this.connType="kalive";this.id=this.fix+"_"+index;json[callName||"callbackname"]=this.callbackName;this.kaliveOptions=$.extend(this.kaliveOptions,json,{ts:$.getTime()});objConnect=this.connectionPooling.getConnect();url=objConnect.url+$.toURI(this.kaliveOptions);this._cacheElement[this.id]=this._createConnect(url,this.id,index,objConnect)},disconnectServer:function(json,cache){var objConnect=this.connectionPooling.getConnect();this.flashGoServer=objConnect.url+$.toURI(cache===false?json:$.extend(json,{ts:$.getTime()}));return this.flashGoServer},disconnect:function(){$.require(this.flashGoServer,function(script){$(script.error?script.target:script).remove()});window[this.callbackName]=emptyFunc},reconnect:function(){this.connect(this.connectOptions)},send:function(data,callback){var self=this,objConnect=this.connectionPooling.getConnect(),url=this.mdyServerAddr(objConnect.url)+$.toURI(data);$.require(url+"#rnd",function(script){self.connectionPooling.recover(objConnect.uri,false);if(callback){callback.call(self,script.error)}$(script.error?script.target:script).remove()});return true},mdyServerAddr:function(url){return url.replace(/\/flashgo/i,"/httpgo")},post:function(data,callback){var self=this,objConnect=this.connectionPooling.getConnect();new $.POST(this.mdyServerAddr(objConnect.url),data,function(){self.connectionPooling.recover(objConnect.uri,false);if(callback){callback.call(self,true)}})},_createConnect:function(uri,id,index,connect){var self=this,script,eventName,head=document.head||nTalk("head")[0]||document.documentElement;script=$({className:id,tag:"script",type:"text/javascript",async:"async",src:uri,charset:"utf-8"}).appendTo(head);eventName=script.get(0).readyState?"onreadystatechange":"onload";script.get(0)[eventName]=script.get(0).onerror=function(event){var reg=/^(loaded|complete|undefined)$/;var readyState=script.get(0).readyState;event=$.Event.fixEvent(event);if(!reg.test(readyState)){return}self.connectionPooling.recover(connect.uri,false);if(event.type!=="error"){setTimeout(function(){self._connectComplete(event,id);script.remove()},$.browser.msie?800:50)}else{self._connectAbnormal(event,id);script.remove()}};this._connectTimeID[id]=setTimeout(function(){script.first().remove();self._connectTimeout("timeout",id)},+this.options.timeout*1e3+1e4);return script.get(0)},_connectCallback:function(id,args){args=Array.prototype.slice.call(args);$("."+id).remove();if(!this._cacheElement[id]){this.options.onCallback.apply(self,[false,args])}else{this._stopCallComplete(id,"callback");this.options.onCallback.apply(self,[true,args])}},_connectComplete:function(event,id){var args=Array.prototype.slice.call(arguments);if(!this._cacheElement[id]){return}this._stopCallComplete(id,"complete");this.options.onComplete.apply(self,[this.connType].concat(args))},_connectAbnormal:function(event,id){var args=Array.prototype.slice.call(arguments);if(!this._cacheElement[id]){return}this._stopCallComplete(id,"abnormal");this.options.onAbnormal.apply(self,[this.connType].concat(args))},_connectTimeout:function(event,id){var args=Array.prototype.slice.call(arguments);if(!this._cacheElement[id]){return}this._stopCallComplete(id,"timeout");this.options.onTimeout.apply(self,[this.connType].concat(args))},_stopCallComplete:function(id){var script=this._cacheElement[id];if(script){script.onload=script.onreadystatechange=script.onerror=emptyFunc}else{$.Log("stop error id:"+id,3)}delete this._cacheElement[id];clearTimeout(this._connectTimeID[id]);delete this._connectTimeID[id]},_createScriptPCID:function(istemp){return"guest"+[istemp?"TEMP"+$.randomChar(4):$.randomChar(8),$.randomChar(4),$.randomChar(4),$.randomChar(4),$.randomChar(12)].join("-")}};$.mqttws=$.Class.create();$.mqttws.prototype={name:"public.mqttws",version:"2015.04.10",connect:null,subscriptions:[],messages:[],connected:false,recCount:0,waitTime:500,_wsKeepaliveId:null,_options:{url:null,siteid:null,pcid:null,onCallback:null,loginMsg:null,timeout:3,keepAliveInterval:90},initialize:function(options){var self=this;this.options=$.extend({},self._options,options);this.options.pcid=(this.options.siteid+"_"+this.options.pcid.substring(5)).substring(0,23);$.require({mqtt:"mosquitto.js?siteid="+$.extParmas.siteid},function(mqtt){self.connect=new $.Mosquitto;self.connect.onmessage=function(topic,payload,qos,retain){var data=$.JSON.parseJSON(payload);self.options.onCallback.apply(this,[true,[data.method].concat(data.params)])};self.connect.ondisconnect=function(message){if(this._wsKeepaliveId!==null){clearInterval(this._wsKeepaliveId);this._wsKeepaliveId=null}};self.connect.onconnect=function(rcMsg){if(rcMsg===0){self.connect.subscribe("foo",0);self.connect.publish("foo",self.options.loginMsg,0,0)}else{self.reconnect()}};self.connect.onreconnect=function(){self.reconnect()};self.connect.connect(self.options.url,self.options.keepAliveInterval,self.options.pcid)})},reconnect:function(){var self=this;if(++this.recCount<3){this._waitTime=500}else{this._waitTime=+"034567890".charAt(Math.ceil(Math.random()*5))*1e3}setTimeout(function(){self.connect.connect(self.options.url,self.options.keepAliveInterval,self.options.pcid)},this._waitTime)},disconnect:function(){this.connect.closeFlag=true;this.connect.disconnect()},kalive:function(aliveMsg){var self=this;if(!this._wsKeepaliveId){this._wsKeepaliveId=setInterval(function(){self.connect.publish("foo",aliveMsg,0,false)},this.options.keepAliveInterval*1e3)}}};$.extend({htmlToElement:function(strHTML){var tElement,rElements;if($.browser.msie){try{tElement=new ActiveXObject("MSXml.DOMDocument");tElement.loadXML(strHTML);rElements=tElement.childNodes}catch(e){tElement=document.createElement("DIV");tElement.innerHTML=strHTML;rElements=tElement.childNodes}}else{tElement=document.createElement("DIV");tElement.innerHTML=strHTML;rElements=tElement.childNodes}return rElements},elementToObject:function(elems){var result={},attName,elem;if($.isArray(elems)||elems.talkVersion){elem=elems[0]}else{elem=elems}result[elem.tagName.toLowerCase()]=elem.innerHTML||elem.text;if(elem.attributes){for(var i=0;i<elem.attributes.length;i++){attName=elem.attributes[i].name;if(attName)result[attName]=elem.attributes[i].value}}else{result.msg=elem.textContent}return result},jsonToxml:function(json){var self=this,returnXml="",temp;if(typeof json=="object"){$.each(json,function(name,item){if(typeof item=="string"&&name=="text")returnXml=item;else if($.isArray(json))returnXml+=self.jsonToxml(item);else{returnXml+="<"+name;if(typeof item.attributes=="object"){for(var attrName in item.attributes){
if(!item.attributes.hasOwnProperty(attrName))continue;returnXml+=" "+attrName+'="'+item.attributes[attrName]+'"'}delete item.attributes}temp=self.jsonToxml(item);if(item&&temp)returnXml+=">"+temp+"</"+name+">";else returnXml+=">"+"</"+name+">"}})}else{return json}return returnXml},utils:{options:{},handleLinks:function(html,options,linkPatternType){this.options=$.extend({},this.options,options);html=html||"";var linkPattern;if(!linkPatternType){linkPattern=this.linkPatterns}else{linkPattern=this.linkPatternsP4}for(var i=0;i<linkPattern.length;i++){html=html.replace(linkPattern[i][0],linkPattern[i][1])}return html},linkPatternsP4:[[/\[link\s+images=[\'\"]+([^\[\]\'\"]+)[\'\"]+\s*[^\[\]]*\]([^\[\]]+)\[\/link\]/gi,'<img width="324" height="146"  onload="globalChatHandle.scrollHistoryToBottom()" src="$1">'],[/\[link\s+submit=[\'\"]+([^\[\]\'\"]+)[\'\"]+\s*[^\[\]]*\]([^\[\]]+)\[\/link\]/gi,'<a class="specil" onclick="NTKF.chatManage.get().send(this.nextSibling.innerHTML, null, this.innerHTML);return false;" href="#">$2</a><span style="display:none;">$1</span>'],[/\[link\s+submit=([^\s\[\]\'\"]+)\s*[^\[\]]*\]([^\[\]]+)\[\/link\]/gi,'<a class="specil" onclick="NTKF.chatManage.get().send(this.nextSibling.innerHTML, null, this.innerHTML);return false;" href="#">$2</a><span style="display:none;">$1</span>'],[/\[link\](.*?)\[\/link\]/gi,'<a class="specil" onclick="NTKF.chatManage.get().send(this.innerHTML);return false;" >$1</a>'],[/<a class="specil" id="submitLink".*?>.*?<\/a>/gi,function(p){return p.replace(/(http|ftp|https)/gi,"$1_")}],[/\[link\s+url=[\'\"]+([^\[\]\'\"]+)[\'\"]+\s*[^\[\]]*\]([^\[\]]+)\[\/link\]/gi,'<a href="$1" target="_blank">$2</a>'],[/\[link\s+url=[\'\"]+([^\[\]\'\"]+)[\'\"]+\s*[^\[\]]*\]([^\[\]]+)\[\/link\]/gi,'<a href="$1" target="_blank">$2</a>'],[/\[link\s+url=([^\s\[\]\'\"]+)\s*[^\[\]]*\]([^\[\]]+)\[\/link\]/gi,'<a href="$1" target="_blank">$2</a>'],[/\[link\s+p4=[\'\"]+([^\[\]\'\"]+)[\'\"]+\s+title=[\'\"]+([^\[\]\'\"]+)[\'\"]+\s*[^\[\]]*\]([^\[\]]+)\[\/link\]/gi,"<a href=\"#\" onclick=\"$client.Activity.openP4('$1','$2');return false;\" >$3</a>"],[/\[link\s+p4=([^\s\[\]\'\"]+)\s+title=([^\s\[\]\'\"]+)\s*[^\[\]]*\]([^\[\]]+)\[\/link\]/gi,"<a href=\"#\" onclick=\"$client.Activity.openP4('$1','$2');return false;\" >$3</a>"],[/\[link\s+p4=[\'\"]+([^\[\]\'\"]+)[\'\"]+\s*[^\[\]]*\]([^\[\]]+)\[\/link\]/gi,"<a href=\"#\" onclick=\"$client.Activity.openP4('$1','$2');return false;\" >$2</a>"],[/\[link\s+p4=([^\s\[\]\'\"]+)\s*[^\[\]]*\]([^\[\]]+)\[\/link\]/gi,"<a href=\"#\" onclick=\"$client.Activity.openP4('$1','$2');return false;\" >$2</a>"],[/(^|[^"'=])((http|https|ftp):\/\/([\w-]+\.)+[\w-]+([\w-.\/?=;!*%$]*)?([\w-&=;!*%$]*)?)/gi,'$1<a href="$2" target="_new">$2</a>'],[/(http|ftp|https)_/gi,"$1"]],linkPatterns:[[/\[link\s+reconnect=([^\s\[\]'"]+)\s*[^\[\]]*]([^\[\]]+)\[\/\s*link]/gi,'<a style="'+$.STYLE_BODY+'display:inline-block;color:#005ffb;text-decoration:none;" href="javascript:void(0);" onclick="nTalk.chatManage.get(\'$1\').reconnect(this);return false;" >$2</a>'],[/\[link\s+message=([^\s\[\]'"]+)\s*[^\[\]]\s*source=([^\s\[\]'"]+)\s*[^\[\]]*]([^\[\]]+)\[\/\s*link]/gi,'<a style="'+$.STYLE_BODY+"display:inline-block;color:#005ffb;text-decoration:none;font-size:"+($.browser.mobile?14:12)+'px;" href="javascript:void(0);" onclick="nTalk.chatManage.get(\'$1\').switchUI(\'message\', $2);return false;" >$3</a>'],[/\[link\s+cancel=([^\s\[\]'"]+)\s+action=([^\s\[\]'"]+)\s*[^\[\]]*]([^\[\]]+)\[\/\s*link]/gi,'<a style="'+$.STYLE_BODY+'display:inline-block;color:#005ffb;text-decoration:none;" href="javascript:void(0);" onclick="nTalk.chatManage.get(\'$1\').cancelUpload(\'$2\');return false;" >$3</a>'],[/\[link\s+resend=([^\s\[\]'"]+)\s+msgid=([^\s\[\]'"]+)\s*[^\[\]]*]([^\[\]]+)\[\/\s*link]/gi,'<a style="'+$.STYLE_BODY+'display:inline-block;color:#005ffb;text-decoration:none;" href="javascript:void(0);" onclick="nTalk.chatManage.get(\'$1\').resend(\'$2\', this);return false;" >$3</a>'],[/\[link\s*manual=([^\s\[\]'"]+)](.*?)\[\/link]/gi,'<a style="'+$.STYLE_BODY+'display:inline-block;color:#005ffb;text-decoration:none;" href="javascript:void(0);" onclick="nTalk.chatManage.get(\'$1\').switchServerType(true);return false;" >$2</a>'],[/\[link\s*artificial=([^\s\[\]'"]+)](.*?)\[\/link]/gi,'<a style="'+$.STYLE_BODY+'display:inline-block;color:#005ffb;text-decoration:none;" href="javascript:void(0);" onclick="nTalk.chatManage.get(\'$1\').switchServerType(true);return false;" >$2</a>'],[/\[link\s*robot](.*?)\[\/link]/gi,'<a style="'+$.STYLE_BODY+'display:inline-block;color:#005ffb;text-decoration:none;" href="javascript:void(0);" onclick="nTalk.chatManage.get().switchServerType(false, 2);return false;" >$1</a>'],[/\[link\s*robotindex=([^\s\[\]'"]+)\s*\](.*?)\[\/link]/gi,'<a style="'+$.STYLE_BODY+'display:inline-block;color:#005ffb;text-decoration:none;" href="javascript:void(0);" onclick="nTalk.chatManage.get(\'{$settingid}\').send(\'$1\');return false;">$2</a>'],[/\[link\s*rightTag=true\s*url="(.*?)"\s*close=(.*?)\s*title="(.*?)"\s*\](.*?)\[\/link\]/gi,'<span style="'+$.STYLE_BODY+'display:inline-block;color:#005ffb;text-decoration:none;cursor:pointer;" rightTag="true" src="$1" closeBtn="$2" title="$3">$4</span>'],[/\[xnlink](.*?)\[\/xnlink]/gi,'<span class="robotQuestion" style="'+$.STYLE_BODY+'display:inline-block;color:#005ffb;text-decoration:none;cursor:pointer;" href="javascript:void(0);" >$1</span>'],[/\[link\s*href=(.*?)](.*?)\[\/link]/gi,'<a style="'+$.STYLE_BODY+'display:inline-block;color:#005ffb;text-decoration:none;cursor:pointer;" href="$1">$2</a>'],[/\[link\s*(.*?)?](.*?)\[\/link]/gi,'<a style="'+$.STYLE_BODY+'display:inline-block;color:#005ffb;text-decoration:none;cursor:pointer;" href="javascript:void(0);"'+($.browser.iOS?' href="$1" target="_blank"':" onclick=\"window.open('$1')\"")+">$2</a>"],[/\{\$(\w+)}/gi,function(a,n){return $.utils.options[n]||""}]]},toHSL:function(c){if($.isHex(c))return $.rgb2HSL($.hex2RGB(c));if($.isRGB(c))return $.rgb2HSL(c);else return c},isHex:function(c){return typeof c=="string"&&/^#?([0-9a-f]{3}|[0-9a-f]{6})$/gi.test(c)},isRGB:function(c){return $.isObject(c)&&$.isDefined(c.r)&&$.isDefined(c.g)&&$.isDefined(c.b)},isHSL:function(c){return $.isObject(c)&&$.isDefined(c.h)&&$.isDefined(c.s)&&$.isDefined(c.l)},hex2RGB:function(sHex){var c=sHex.toString().replace("#",""),a=c.split(""),oRGB={};if(c.length==3){oRGB={r:parseInt(a[0]+a[0],16),g:parseInt(a[1]+a[1],16),b:parseInt(a[2]+a[2],16)}}else if(c.length==6){oRGB={r:parseInt(a[0]+a[1],16),g:parseInt(a[2]+a[3],16),b:parseInt(a[4]+a[5],16)}}else{oRGB={r:0,g:0,b:0}}return oRGB},rgb2HSL:function(oRGB){var R,G,B,del_R,del_G,del_B,Min,Max,del_Max,oHSL={};R=oRGB.r/255;G=oRGB.g/255;B=oRGB.b/255;Min=Math.min(R,G,B);Max=Math.max(R,G,B);del_Max=Max-Min;oHSL.l=(Max+Min)/2;if(del_Max===0){oHSL.h=0;oHSL.s=0}else{if(oHSL.l<.5)oHSL.s=del_Max/(Max+Min);else oHSL.s=del_Max/(2-Max-Min);del_R=((Max-R)/6+del_Max/2)/del_Max;del_G=((Max-G)/6+del_Max/2)/del_Max;del_B=((Max-B)/6+del_Max/2)/del_Max;if(R==Max)oHSL.h=del_B-del_G;else if(G==Max)oHSL.h=1/3-del_B+del_R;else if(B==Max)oHSL.h=2/3-del_R+del_G;if(oHSL.h<0)oHSL.h+=1;if(oHSL.h>1)oHSL.h-=1}return oHSL}});$.fn.extend({animate:function(options,duration,callback){return $.each(this,function(i,elem){$.animate(elem,options,duration,callback)})},show:function(duration,callback){if($.isFunction(duration)){callback=duration;duration=500}return this.animate({visibility:"visible",opacity:{from:0,to:1}},duration||500,callback)},hide:function(duration,callback){if($.isFunction(duration)){callback=duration;duration=500}return this.animate({opacity:{to:0}},duration||500,callback)},gradient:function(direction,scolor,ecolor){var dp,c;if(!direction){return $.each(this,function(i,element){if($.browser.oldmsie)$(element).css("filter","none");else $(element).css("background-image","none")})}else{return $.each(this,function(i,element){if($.browser.oldmsie){dp=/top|bottom/.test(direction)?0:1;if(/right|bottom/.test(direction)){c=scolor;scolor=ecolor;ecolor=c}}if($.browser.webkit){switch(direction){case"top":dp="0% 100%,0% 0%";break;case"right":dp="0% 0%,100% 0%";break;case"bottom":dp="0% 0%,0% 100%";break;case"left":dp="100% 0%,0% 0%";break}$(element).css("background-image",!direction?"none":"-webkit-gradient(linear,"+dp+",color-stop(1, "+scolor+"),color-stop(0, "+ecolor+"))")}else if($.browser.gecko){$(element).css("background-image",!direction?"none":"-moz-linear-gradient("+direction+", "+scolor+", "+ecolor+")")}else if($.browser.oldmsie){var gradientExp=/progid:DXImageTransform\.Microsoft\.gradient\((.*?)\)\s*/gi;element.style.filter=element.currentStyle.filter.replace(gradientExp,"")+(!direction?"":" progid:DXImageTransform.Microsoft.gradient(GradientType="+dp+",startColorstr='"+scolor+"', endColorstr='"+ecolor+"')")}else if($.browser.msie){$(element).css("background-image",!direction?"none":"-ms-linear-gradient("+direction+", "+scolor+", "+ecolor+")")}else{$(element).css("background-image",!direction?"none":"linear-gradient("+direction+", "+scolor+", "+ecolor+")")}})}}});$.extend({base64:{_strKey:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(input){var self=$.base64;var output="";var chr1,chr2,chr3,enc1,enc2,enc3,enc4;var i=0;input=self._utf8_encode(input||"");while(i<input.length){chr1=input.charCodeAt(i++);chr2=input.charCodeAt(i++);chr3=input.charCodeAt(i++);enc1=chr1>>2;enc2=(chr1&3)<<4|chr2>>4;enc3=(chr2&15)<<2|chr3>>6;enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64}else if(isNaN(chr3)){enc4=64}output=output+self._strKey.charAt(enc1)+self._strKey.charAt(enc2)+self._strKey.charAt(enc3)+self._strKey.charAt(enc4)}return output},decode:function(input){var self=$.base64;var output="";var chr1,chr2,chr3;var enc1,enc2,enc3,enc4;var i=0;input=(input||"").replace(/[^A-Za-z0-9\+\/=]/g,"");while(i<input.length){enc1=self._strKey.indexOf(input.charAt(i++));enc2=self._strKey.indexOf(input.charAt(i++));enc3=self._strKey.indexOf(input.charAt(i++));enc4=self._strKey.indexOf(input.charAt(i++));chr1=enc1<<2|enc2>>4;chr2=(enc2&15)<<4|enc3>>2;chr3=(enc3&3)<<6|enc4;output=output+String.fromCharCode(chr1);if(enc3!=64){output=output+String.fromCharCode(chr2)}if(enc4!=64){output=output+String.fromCharCode(chr3)}}output=self._utf8_decode(output);return output},_utf8_encode:function(string){string=string.replace(/\r\n/g,"\n");var utftext="";for(var n=0;n<string.length;n++){var c=string.charCodeAt(n);if(c<128){utftext+=String.fromCharCode(c)}else if(c>127&&c<2048){utftext+=String.fromCharCode(c>>6|192);utftext+=String.fromCharCode(c&63|128)}else{utftext+=String.fromCharCode(c>>12|224);utftext+=String.fromCharCode(c>>6&63|128);utftext+=String.fromCharCode(c&63|128)}}return utftext},_utf8_decode:function(utftext){var string="";var i=0;var c,c2,c3;while(i<utftext.length){c=utftext.charCodeAt(i);if(c<128){string+=String.fromCharCode(c);i++}else if(c>191&&c<224){c2=utftext.charCodeAt(i+1);string+=String.fromCharCode((c&31)<<6|c2&63);i+=2}else{c2=utftext.charCodeAt(i+1);c3=utftext.charCodeAt(i+2);string+=String.fromCharCode((c&15)<<12|(c2&63)<<6|c3&63);i+=3}}return string}},FORM:{createInput:function(cfgRequiredField,appendTdParams,noNullChar){var trHtml=[],formField,option,checked,formTitle,mobile=$.browser.mobile,appendTd=$.extend({id:"",rowspan:0,style:""},appendTdParams),required='<span class="ntkf-text-red" style="'+$.STYLE_BODY+'padding:2px 5px 2px 0;color:#f00;">'+(noNullChar||"")+"</span>";for(var i=0;i<cfgRequiredField.length;i++){formField=$.extend({titlewidth:"80px",inputwidth:"auto",input:{width:"90%",height:"auto"}},cfgRequiredField[i]);if(!mobile){formTitle=formField.title+(formField.title.length==$.enLength(formField.title)?":":"：")}else{formTitle=formField.title}if(/zh_cn|zh_tw/.test($.lang.language)&&$.enLength(formField.title)>16||formField.multipart||/radio|checkbox/.test(formField.type)&&formField.options.length>2){formField.multipart=true;trHtml.push(mobile?'<tr style="'+$.STYLE_BODY+'">'+'<td style="'+$.STYLE_BODY+'width:100%;"><div class="nt-mobile-form-title" style="'+$.STYLE_BODY+'width:100%; line-height:14px; font-size:14px; font-weight:bold; text-align:center; color:#333333; margin: 15px 0px 20px 0px">'+formTitle+"</div>":['<tr style="',$.STYLE_BODY,'">','<td style="',$.STYLE_BODY,'vertical-align:top;line-height:28px;color:#333;" colspan="2">','<div style="',$.STYLE_BODY,'margin:5px 10px 5px 10px;color:#5a5a5a;">',formTitle,formField.required===true?required:"","</div>","</td>","</tr>",'<tr style="'+$.STYLE_BODY+'"><td style="',$.STYLE_BODY,'padding:0 5px 0 0;text-align:right;vertical-align:top;line-height:28px;color:#333;"></td>','<td style="'+$.STYLE_BODY+"line-height:28px;width:"+formField.inputwidth+';">'].join(""))}else{trHtml.push('<tr style="'+$.STYLE_BODY+'">'+(mobile?"":'<td style="'+$.STYLE_BODY+"padding:0 5px 0 0;text-align:right;vertical-align:top;line-height:28px;color:#333;width:"+formField.titlewidth+';">'+'<div style="'+$.STYLE_BODY+'margin:4px 0 0 0;text-align:right;color:#5a5a5a;">'+(formField.required===true?required:"")+formTitle+"</div></td>")+'<td style="'+$.STYLE_BODY+"line-height:28px;width:"+(mobile?"100%":formField.inputwidth)+';">')}switch(formField.type){case"select":trHtml.push('<select data-index="'+i+'" name="'+formField.name+'" style="'+$.STYLE_BODY+"border:1px solid #ccc;height:24px;color:#333;margin:0 0 4px;line-height:20px;width:"+(mobile?"99%":formField.input.width)+';">');trHtml.push('<option value="" style="'+$.STYLE_BODY+'color:#ccc;">'+formField.defaultText+"</option>");for(var ii=0;ii<formField.options.length;ii++){option=formField.options[ii];option=typeof option=="string"?{text:option,value:option}:option;trHtml.push('<option value="'+option.value+'" style="'+$.STYLE_BODY+'color:#333;">'+option.text+"</option>")}trHtml.push("</select>");break;case"radio":trHtml.push('<ul style="'+$.STYLE_BODY+'list-style:none;">');for(var j=0,radioId;j<formField.options.length;j++){option=formField.options[j];option=typeof option=="string"?{text:option,value:option}:option;radioId=formField.name+"_"+j;checked=formField.defaultText==option.value?" checked":"";trHtml.push('<li class="form-item" style="'+$.STYLE_BODY+'list-style:none;padding:0 2px 0 0;color:#000;float:left;">'+'<input type="radio" name="'+formField.name+'"id="'+radioId+'" value="'+option.value+'" _custom_text="'+option.text+'" style="'+$.STYLE_BODY+'color:#333;outline:none;-webkit-appearance:radio"'+checked+" />"+'<label for="'+radioId+'" style="'+$.STYLE_BODY+'display:inline;color:#000;">'+option.text+"</label></li>")}trHtml.push('<li style="'+$.STYLE_BODY+'list-style:none;clear:both;width:0;height:0;"></li>');trHtml.push("</ul>");break;case"checkbox":trHtml.push('<ul style="'+$.STYLE_BODY+'list-style:none;">');for(var k=0,checkboxId;k<formField.options.length;k++){option=formField.options[k];option=typeof option=="string"?{text:option,value:option}:option;checkboxId=formField.name+"_"+k;checked=formField.defaultText==option.value?" checked":"";trHtml.push('<li class="form-item" style="'+$.STYLE_BODY+'list-style:none;padding:0 2px 0 0;float:left;">'+'<input type="checkbox" name="'+formField.name+'" id="'+checkboxId+'" value="'+option.value+'" _custom_text="'+option.text+'" style="'+$.STYLE_BODY+'color:#333;"'+checked+" />"+'<label for="'+checkboxId+'" style="'+$.STYLE_BODY+'display:inline;color:#000;">'+option.text+"</label></li>")}trHtml.push('<li style="'+$.STYLE_BODY+'list-style:none;clear:both;width:0;height:0;"></li>');trHtml.push("</ul>");break;case"textarea":trHtml.push('<textarea data-index="'+i+'" name="'+formField.name+'" style="'+$.STYLE_BODY+"border:1px solid #ccc;color:#ccc;width:"+(mobile?"99%":formField.input.width)+";height:"+formField.input.height+';"'+($.browser.html5?' placeholder="'+formField.defaultText+'">':">"+formField.defaultText)+"</textarea>");break;default:trHtml.push('<input data-index="'+i+'" type="text" name="'+formField.name+'"'+($.browser.html5?' placeholder="'+formField.defaultText+'" value=""':' value="'+formField.defaultText+'"')+' maxlength="32" style="'+$.STYLE_BODY+"border:1px solid #ccc;height:24px;width:"+(mobile?"99%":formField.input.width)+';margin:0 0 4px;color:#ccc;"');if(formField.verification=="phone"){trHtml.push(" onblur=\"this.value=this.value.replace(/[^0-9-]+/, '');\" onkeyup=\"var keyCode=(event || window.event).keyCode; if( !/16|17|35|36|37|38|39|40/i.test(keyCode) ){this.value=this.value.replace(/[^0-9-]+/, '');}\"")}trHtml.push(" />");break}if(formField.messageid){trHtml.push('<div style="'+$.STYLE_BODY+'display:none;color:#EF7208;" class="form-info '+formField.messageid+'">');trHtml.push('<div style="'+$.STYLE_BODY+"margin:2px;width:15px;height:15px;float:left;background:transparent url("+$.sourceURI+'/images/chaticon.png) no-repeat -160px -39px;"></div>');trHtml.push('<div style="'+$.STYLE_BODY+'color:#EF7208;float:left;" class="chat-view-info"></div>');trHtml.push('<div style="'+$.STYLE_BODY+'clear:both;width:0;height:0;"></div>');trHtml.push("</div>")}trHtml.push("</td>");if(appendTd.style&&i===0){trHtml.push('<td style="'+$.STYLE_BODY+appendTd.style+'" id="'+appendTd.id+'" rowspan="'+appendTd.rowspan+'"></td></tr>')}}return trHtml.join("")},bindFormEvent:function(cfgRequiredField,parent){var focusfunc=function(){var element=$(this).css({color:"#333","border-color":$.browser.mobile?"#0079fe":"#666"}),index=element.attr("data-index")||0,def=cfgRequiredField[index].defaultText;if(def==element.val())element.val("")};var blurfunc=function(){var element=$(this).css("border-color","#ccc"),index=element.attr("data-index")||0,def=cfgRequiredField[index].defaultText;if(element.val()==="")element.val(def);if(element.val()===""||element.val()==def){element.css("color","#ccc")}};$(parent).find("input[type=text]").bind("focus",focusfunc).bind("blur",blurfunc);$(parent).find("textarea").bind("focus",focusfunc).bind("blur",blurfunc)},verificationForm:function(fields,fnCallback,parentElement,failCallback){var element,selectElem,isNull,returnValue=[],showNews,value,failFlag=false,phone=new RegExp("\\d{6,}","i"),email=new RegExp("^[a-zA-Z0-9\\._-]+@[a-zA-Z0-9_-]+(\\.[a-zA-Z0-9_-]+)+$","i"),self=this,tmpFunc=function(ii,element){if(!element.checked)return;value={value:$(element).val()||"",text:$(element).attr("_custom_text")}},displayFunc=function(){$(this).display()};for(var i=0;i<fields.length;i++){switch(fields[i].type){case"checkbox":value=[];element=$(parentElement).find("input[name="+fields[i].name+"]");selectElem=$(parentElement).find("input[name="+fields[i].name+"][checked]");for(var j=0;j<selectElem.length;j++)value.push({value:selectElem.get(j).value,text:$(selectElem.get(j)).attr("_custom_text")});break;case"radio":value={value:"",text:""};element=$(parentElement).find("input[name="+fields[i].name+"]");$(parentElement).find("input[name="+fields[i].name+"][checked]").each(tmpFunc);break;case"select":element=$(parentElement).find("select[name="+fields[i].name+"]");value=$("option[selected]",element).val()||"";value=fields[i].defaultText&&value==fields[i].defaultText?"":value;break;case"textarea":element=$(parentElement).find("textarea[name="+fields[i].name+"]");if(fields[i].defaultText&&fields[i].defaultText==element.val()){value="";element.val("")}else value=element.val().replace(/(\")|(\')|((^\s*)|(\s*$))/g,"");break;default:element=$(parentElement).find("input[name="+fields[i].name+"]");if(fields[i].defaultText&&fields[i].defaultText==element.val()){value="";element.val("")}else value=element.val().replace(/(^\s*)|(\s*$)/g,"")}if(typeof value=="string"){isNull=value===""||!value.length}else if($.isArray(value)){isNull=value.length===0}else{isNull=value.value===""}showNews=fields[i].messageid&&fields[i].message?true:false;var infodiv=$(parentElement).find("."+fields[i].messageid);var info=$(parentElement).find("."+fields[i].messageid+" .chat-view-info");if(fields[i].required&&isNull){self.showError(showNews,fields[i].message[0],info,infodiv,element,fields[i].type);failFlag=true}else if(fields[i].verification=="phone"&&!isNull&&!phone.test(value)){self.showError(showNews,fields[i].message[1],info,infodiv,element);failFlag=true}else if(fields[i].verification=="email"&&!isNull&&!email.test(value)){self.showError(showNews,fields[i].message[1],info,infodiv,element);failFlag=true}else if(fields[i].min&&!isNull&&$.enLength(value)<fields[i].min){self.showError(showNews,fields[i].message[1],info,infodiv,element);failFlag=true}else if(fields[i].max&&!isNull&&$.enLength(value)>fields[i].max){self.showError(showNews,fields[i].message[2],info,infodiv,element);failFlag=true}else{if(showNews){infodiv.hide(displayFunc)}else if(/radio|checkbox/.test(fields[i].type))element.parent().css("color","#333");else element.css("border-color","#DBD8D1");if(!isNull)returnValue.push({name:fields[i].name,title:fields[i].title,value:value})}}if(failFlag){if(typeof failCallback=="function")failCallback();return}else{$.Log("form submit complete, failCallback is null",3)}if(typeof fnCallback=="function"){fnCallback(returnValue)}else{$.Log("form submit complete, callback is null",3)}},showError:function(showNews,message,info,infodiv,element,type){var self=this;if(showNews&&message){if(!$.browser.mobile){info.html(message);infodiv.display(1).show();element.get(0).focus()}else{if(this.messageErrorToast){this.messageErrorToast.remove();this.messageErrorToast=null;if(this.messageErrorTimeout)clearTimeout(this.messageErrorTimeout)}var width=message.length>10?300:250;this.messageErrorToast=new $.Toast('<div id="#message_error" style="position: relative;width: '+(width-50)+'px; height:30px; line-height: 30px;z-index:100; color: #FFF; top: 30px; left: 25px; text-align:center;font-weight:bold">'+message+"</div>",{width:width,height:90});this.messageErrorTimeout=setTimeout(function(){self.messageErrorToast.remove();self.messageErrorToast=null;element.get(0).focus()},2e3)}}else if(/radio|checkbox/.test(type)){element.parent().css("color","#f00")}else{element.css("border-color","#f00").get(0).focus()}}}});$.Transfer=$.Class.create();$.Transfer.prototype={name:"Transfer",button:null,element:null,form:null,iframe:null,proxy:null,options:null,debug:true,fkey:"",initialize:function(options,button){this.button=button;var tmpName=$.randomChar(16);this.options=$.extend({onError:emptyFunc,onChange:emptyFunc,callback:emptyFunc,name:tmpName,curName:"",compSize:1024*500,params:{},target:"iframe-transfer-"+tmpName},options);if(!this.options.server){$.Log("server is null",3);return}this.proxy=$({tag:"IFRAME",name:"proxy-"+tmpName,src:this.options.server.substring(0,this.options.server.lastIndexOf("/"))+"/proxy.html?t="+$.getTime(),style:$.STYLE_NBODY+"width:0px;height:0px;display:none;"}).appendTo($(this.button)).get(0).contentWindow;var self=this,width=Math.max(20,this.button.width(),parseFloat(this.button.css("width"))),height=Math.max(20,this.button.height(),parseFloat(this.button.css("height"))),style=$.STYLE_BODY+"width:"+width+"px;height:"+height+"px;overflow:hidden;";this.completed=function(event){var reg=/^(?:loaded|complete|undefined)$/;var readyState=this.readyState;if(!reg.test(readyState))return;self.iframe.removeEvent("readystatechange",self.completed).removeEvent("load",self.completed);self.transferComplete(event,self.fkey)};this.form=$({tag:"FORM",action:"",method:"POST",target:this.options.target,enctype:"multipart/form-data",style:style}).appendTo(this.button,true);this.iframe=$({tag:"IFRAME",name:this.options.target,src:"about:blank",style:style+"width:0;height:0;display:none;"}).appendTo(this.button,true);this.element=$({tag:"INPUT",type:"file",name:this.options.name,accept:this.options.accept||"*",style:style,title:this.button.attr("title")||""}).appendTo(this.form,true).css("opacity",0);this.element.click(function(){if(this.value!==""){self.form.get(0).reset()}self.iframe.bind("readystatechange",self.completed).bind("load",self.completed);self.fkey=$.randomChar(16)}).bind("change",function(event){var fileInfo={};if(!this.files){fileInfo.name=this.value.substring(this.value.lastIndexOf("\\")+1);fileInfo.size=""}else{fileInfo.name=this.files[0].name;fileInfo.size=this.files[0].size}if(fileInfo.name){self.options.onChange(fileInfo);self.fileChange(event,this.files||this.value)}})},transferComplete:function(event,fkey){var self=this;if(!fkey){return}if(this.debug){$.Log("$.upload.transferComplete(event, "+fkey+")")}$.jsonp(this.options.server+"?"+$.toURI($.extend({getaction:1,fkey:fkey},this.options.params))+"#rnd",function(data){if(self.debug){$.Log("get transfer file info:"+$.JSON.toJSONString(data),1)}data.name=self.options.curName||self.options.name||"";self.options.callback(data)})},fileChange:function(event,files){var self=this;this.isMobileCompTransf(files,function(mFlag){if(mFlag){if($.browser.oldAndroid){$.require("jpeg_encoder_basic.js?siteid="+self.options.params.siteid,function(encode){self.mobileCompTransf(event,files)})}else if($.browser.oldIOS){$.require("megapix-image.js?siteid="+self.options.params.siteid,function(encode){self.mobileCompTransf(event,files)})}else{self.mobileCompTransf(event,files)}}else{self.commonTransf(event,files)}})},isMobileCompTransf:function(files,callback){if($.browser.mobile&&(window.URL||window.webkitURL)&&document.createElement("canvas")){if(files[0].name.toLowerCase().indexOf("jpg")>-1){callback(true)}else if(window.FileReader&&window.DataView){var self=this;var fileReader=new FileReader;fileReader.onload=function(e){var dataView=new DataView(e.target.result);if(dataView.getUint8(0)==255&&dataView.getUint8(1)==216){callback(true)}else{callback(false)}};fileReader.readAsArrayBuffer(files[0])}else{callback(false)}}else{callback(false)}},commonTransf:function(event,files){var fileAction=this.options.params.action=="uploadfile"?true:false;var proxyMaxSize,proxyExt;try{proxyMaxSize=fileAction?this.proxy.fileOptions.fileMaxSize:this.proxy.fileOptions.imageMaxSize;proxyExt=fileAction?this.proxy.fileOptions.fileExt:this.proxy.fileOptions.imageExt}catch(e){proxyMaxSize=null;proxyExt=null}var accept;if(typeof files==="string"){if(this.debug)$.Log("Name: "+files,2)}else{for(var reg,i=0;i<files.length;i++){var file=files[i],ext;if(file.name.indexOf(".")>-1){ext=file.name.match(/\.[^\.]+$/)[0].replace(".","").toLowerCase()}else{ext=""}if(this.options.maxSize&&file.size>this.options.maxSize||proxyMaxSize&&file.size>proxyMaxSize){this.options.onError({type:9,name:file.name,size:file.size,etype:"SIZE",maxSize:this.options.maxSize||proxyMaxSize});return}if((this.options.accept=="*"||!this.options.accept)&&!proxyExt){continue}else if(this.options.accept&&this.options.accept.indexOf("/*")>-1){reg=new RegExp(this.options.accept.replace(/\//,"\\/"),"gi");if(!reg.test(file.type)){$.Log("accept:"+this.options.accept+", type:"+file.type,2);this.options.onError({type:9,name:file.name,size:file.size,etype:"TYPE"});return}}else if(this.options.accept&&this.options.accept.indexOf(file.type)<=-1){$.Log("accept:"+this.options.accept+", type:"+file.type,2);this.options.onError({type:9,name:file.name,size:file.size,etype:"TYPE"});return}else if(proxyExt&&proxyExt.indexOf(ext)>-1){continue}else if(proxyExt&&proxyExt.indexOf(ext)==-1){this.options.onError({type:9,name:file.name,size:file.size,ext:proxyExt,etype:"TYPE"});return}this.options.curName=file.name;if(this.debug)$.Log("Name: "+this.options.curName)}}if(this.debug){$.Log("$.upload.fileChange()")}this.form.attr("action",this.options.server+"?"+$.toURI($.extend({fkey:this.fkey,rnd:$.getTime()},this.options.params)));if($.browser.mobile){this.options.callback({status:"startUpload",oldfile:files[0].name})}this.form.get(0).submit()},mobileCompTransf:function(event,files){var self=this;this.options.callback({status:"startCompress",oldfile:files[0].name});this.fkey=$.getTime();var Oriention=new $.ImageOrientation(files[0],function(event,orientation){var compImg=new $.CompressImg(files[0],{orientation:orientation},function(event,dataurl){new $.POST(self.options.server+"?action=uploadimage",$.extend({base64:dataurl,fname:$.getTime()+".png",fkey:self.fkey,rnd:$.getTime()},self.options.params),function(e){self.transferComplete(e,self.fkey)});self.options.callback({status:"startUpload",oldfile:files[0].name,compress:true})})})},base64Transf:function(dataurl){var self=this;this.fkey=$.getTime();new $.POST(this.options.server+"?action=uploadimage",$.extend({base64:dataurl,fname:$.getTime()+".png",fkey:this.fkey,rnd:$.getTime()},this.options.params),function(e){self.transferComplete(e,self.fkey)})}};$.CompressImg=$.Class.create();$.CompressImg.prototype={ctx:null,canvas:null,url:null,image:null,blob:null,compBlob:null,dataurl:null,resize:{width:null,height:null},options:{width:null,height:null,quality:.7},initialize:function(file,options,callback){var self=this;this.url=window.URL||window.webkitURL;this.canvas=document.createElement("canvas");this.blob=typeof file==="string"?file:this.url.createObjectURL(file);this.options=$.extend(options,this.options);this.image=new Image;this.image.onerror=function(){$.Log("加载图片失败！")};this.image.onload=function(e){self.getCompImage();callback(e,self.dataurl);var timeout=$.browser.oldIOS?1e4:0;setTimeout(function(){for(var p in self){if(!self.hasOwnProperty(p))continue;self[p]=null}},timeout)};this.image.crossOrigin="*";this.image.src=self.blob},drawOldIOSCanvas:function(){var mpImg=new MegaPixImage(this.image);if("5678".indexOf(this.options.orientation)>-1){mpImg.render(this.canvas,{width:this.canvas.height,height:this.canvas.width,orientation:this.options.orientation})}else{mpImg.render(this.canvas,{width:this.canvas.width,height:this.canvas.height,orientation:this.options.orientation})}},drawCanvas:function(){var self=this;switch(self.options.orientation){case 3:this.ctx.rotate(180*Math.PI/180);this.ctx.drawImage(this.image,-this.resize.width,-this.resize.height,this.resize.width,this.resize.height);break;case 6:this.ctx.rotate(90*Math.PI/180);this.ctx.drawImage(this.image,0,-this.resize.width,this.resize.height,this.resize.width);break;case 8:this.ctx.rotate(270*Math.PI/180);this.ctx.drawImage(this.image,-this.resize.height,0,this.resize.height,this.resize.width);break;case 2:this.ctx.translate(resize.width,0);this.ctx.scale(-1,1);this.ctx.drawImage(this.image,0,0,this.resize.width,this.resize.height);break;case 4:this.ctx.translate(resize.width,0);this.ctx.scale(-1,1);this.ctx.rotate(180*Math.PI/180);this.ctx.drawImage(this.image,-this.resize.width,-this.resize.height,this.resize.width,this.resize.height);break;case 5:this.ctx.translate(resize.width,0);this.ctx.scale(-1,1);this.ctx.rotate(90*Math.PI/180);this.ctx.drawImage(this.image,0,-this.resize.width,this.resize.height,this.resize.width);break;case 7:this.ctx.translate(resize.width,0);this.ctx.scale(-1,1);this.ctx.rotate(270*Math.PI/180);this.ctx.drawImage(this.image,-this.resize.height,0,this.resize.height,this.resize.width);break;default:this.ctx.drawImage(this.image,0,0,this.resize.width,this.resize.height)}},getCompImage:function(){var self=this;this.ctx=this.canvas.getContext("2d");this.resize=this._getResize();this.canvas.width=this.resize.width;this.canvas.height=this.resize.height;this.ctx.fillStyle="#fff";this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);if($.browser.oldIOS){this.drawOldIOSCanvas()}else{this.drawCanvas()}if($.browser.oldAndroid){var encoder=new JPEGEncoder,img=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height);this.dataurl=encoder.encode(img,this.options.quality*100)}else{this.dataurl=this.canvas.toDataURL("image/jpeg",this.options.quality)}this.url.revokeObjectURL(self.blob)},_getResize:function(){var self=this,img=this.image,width=this.options.width,height=this.options.height;var ret={width:img.width,height:img.height};if("5678".indexOf(self.options.orientation)>-1){ret.width=img.height;ret.height=img.width}var scale=ret.width/ret.height;if(width&&height){if(scale>=width/height){if(ret.width>width){ret.width=width;ret.height=Math.ceil(width/scale)}}else{if(ret.height>height){ret.height=height;ret.width=Math.ceil(height*scale)}}}else if(width){if(width<ret.width){
ret.width=width;ret.height=Math.ceil(width/scale)}}else if(height){if(height<ret.height){ret.width=Math.ceil(height*scale);ret.height=height}}while(ret.width>=3264||ret.height>=2448){ret.width*=.8;ret.height*=.8}return ret}};$.ImageOrientation=$.Class.create();$.ImageOrientation.prototype={initialize:function(file,callback){if(!window.FileReader||!window.DataView){return 1}var self=this;var fileReader=new FileReader;fileReader.onload=function(e){callback($.Event.fixEvent(e),self._readImageOrientation(e.target.result))};fileReader.readAsArrayBuffer(file)},_readImageOrientation:function(file){var dataView=new DataView(file);if(dataView.getUint8(0)!=255||dataView.getUint8(1)!=216){return 1}var offset=2,length=file.byteLength,marker;while(offset<length){if(dataView.getUint8(offset)!=255){return 1}marker=dataView.getUint8(offset+1);if(marker==225){return this._getOrientationFromExif(dataView,offset+4,dataView.getUint16(offset+2)-2)}else{offset+=2+dataView.getUint16(offset+2)}}},_getOrientationFromExif:function(file,start){if(this._getStringFromDB(file,start,4)!="Exif"){return 1}var bigEnd,tags,tag,exifData,tiffOffset=start+6;if(file.getUint16(tiffOffset)==18761){bigEnd=false}else if(file.getUint16(tiffOffset)==19789){bigEnd=true}else{return 1}if(file.getUint16(tiffOffset+2,!bigEnd)!=42){return 1}var firstIFDOffset=file.getUint32(tiffOffset+4,!bigEnd);if(firstIFDOffset<8){return 1}return this._getOrientationFromTag(file,tiffOffset,tiffOffset+firstIFDOffset,bigEnd)},_getOrientationFromTag:function(file,tiffStart,dirStart,bigEnd){var entries=file.getUint16(dirStart,!bigEnd),tags={},entryOffset,tag,i;for(i=0;i<entries;i++){entryOffset=dirStart+i*12+2;tag=file.getUint16(entryOffset,!bigEnd);if(tag==274){return this._getOrientationValue(file,entryOffset,tiffStart,dirStart,bigEnd)}}return 1},_getOrientationValue:function(file,entryOffset,tiffStart,dirStart,bigEnd){var type=file.getUint16(entryOffset+2,!bigEnd),numValues=file.getUint32(entryOffset+4,!bigEnd),valueOffset=file.getUint32(entryOffset+8,!bigEnd)+tiffStart,offset,vals,val,n;switch(type){case 3:if(numValues==1){return file.getUint16(entryOffset+8,!bigEnd)}else{offset=numValues>2?valueOffset:entryOffset+8;vals=[];for(n=0;n<numValues;n++){vals[n]=file.getUint16(offset+2*n,!bigEnd)}return vals}}},_getStringFromDB:function(buffer,start,length){var outstr="";for(n=start;n<start+length;n++){outstr+=String.fromCharCode(buffer.getUint8(n))}return outstr}};$.DialogChat=new $.Class.create;$.DialogChat.prototype={contains:null,background:null,iframe:null,display:false,selector:"",def:{close:false,parent:window,margin:10,border:0,style:{height:"auto"},resizeFunc:null},options:null,_funcResize:emptyFunc,initialize:function(html,options){var self=this;this.options=$.extend({},this.def,options);this.id=$.randomChar();this.selector=".dialog-container-"+this.id;this._create();this._style(this.options.style);this.display=true;if(!!this.options.close){html+='<div class="dialog-button-close" style="'+$.STYLE_NBODY+'font-size:14px;position:absolute;right:10px;top:10px;width:20px;height:20px;line-height:20px;text-align:center;cursor:pointer;">x</div>'}this.container.html(html);setTimeout(function(){self.container.css({top:Math.max(0,($(self.options.parent).height()-Math.max(self.container.height(),200))/2)+"px"})},5);this._funcResize=function(){self.resize()};if(this.options.parent==window){$(window).addEvent("resize",this._funcResize)}this.container.find(".dialog-button-close").click(function(){self.close()})},close:function(){var self=this;if(this.options.parent==window){$(window).removeEvent("resize",this._funcResize)}$(this.selector).hide(function(){$(".dialog-iframe-"+self.id+",.dialog-background-"+self.id).remove();$(self.selector).remove();self.display=false})},resize:function(width,height){width=width||$(this.options.parent).width();height=height||$(this.options.parent).height();$(".dialog-iframe-"+this.id+",.dialog-background-"+this.id).css({width:width+"px",height:height+"px"});var computeHeight=this.options.style.height==="auto"?"auto":height-this.options.margin*2-this.options.border*2;this.container.css({width:width-this.options.margin*2-this.options.border*2+"px",height:computeHeight=="auto"?"auto":computeHeight+"px","max-width":width+"px","max-height":height-40+"px"});this.container.css("top",Math.max(0,(height-Math.max(computeHeight=="auto"?this.container.height():computeHeight,200))/2)+"px");if(this.options.resizeFunc)this.options.resizeFunc.call()},_create:function(){var body=this.options.parent==window?document.body:this.options.parent;var position=this.options.parent==window?"fixed":"absolute";this.iframe=$({tag:"IFRAME",className:"dialog-iframe-"+this.id,style:$.STYLE_NBODY+"position:"+position+";display:none;left:0;top:0;margin:0;padding:0;border:0;width:100%;z-index:8888;"}).appendTo(body);this.background=$({tag:"div",className:"dialog-background-"+this.id,style:$.STYLE_NBODY+"position:"+position+";left:0;top:0;margin:0;padding:0;border:0;width:100%;background-color:#000;z-index:8888;"}).appendTo(body);var zIndex=$.browser.mobile?9e3:2147483647;this.container=$({tag:"div",className:"dialog-container-"+this.id,style:$.STYLE_BODY+"position:"+position+";left:0;top:0;margin:0;min-height:"+(this.options.minHeight?this.options.minHeight:200)+"px;border-radius:0px;z-index:"+zIndex+";background:#fff;overflow-x:hidden;overflow-y:auto;"}).appendTo(body);this.background.bind("touchstart",function(e){var event=$.Event.fixEvent(e);event.stopPropagation();event.preventDefault()}).bind("touchend",function(e){var event=$.Event.fixEvent(e);event.stopPropagation();event.preventDefault()})},_style:function(style){var width=$(this.options.parent).width();var height=$(this.options.parent).height();$(".dialog-iframe-"+this.id+",.dialog-background-"+this.id).css({width:width+"px",height:$(this.options.parent).height()+"px"});this.background.css({opacity:.6});var marginArray=(this.options.margin+"").split(" ");if(marginArray.length==1){marginArray.push(this.options.margin)}this.container.css(style).css({left:marginArray[0]+"px",top:marginArray[1]+"px",width:width-marginArray[0]*2-this.options.border*2+"px",height:this.options.style.height==="auto"?"auto":height-marginArray[1]*2-this.options.border*2+"px"})}};$.Toast=new $.Class.create;$.Toast.prototype={id:null,container:null,toast:null,options:{},initialize:function(html,options){var self=this;this.id=$.randomChar();this.options=$.extend(this.options,options);this.toastOpacity=$({tag:"div",className:"toast-opacity-"+this.id,style:$.STYLE_BODY+"position:relative;z-index:9000;width:"+this.options.width+"px;height:"+this.options.height+"px;margin-left:"+($(window).width()-this.options.width)/2+"px;margin-top:"+($(window).scrollTop()+($(window).height()-this.options.height-100)/2)+"px;background-color:#000;opacity:0.5;border-radius:5px;font-size:16px;color:white;text-align:center;line-height:"+this.options.height+"px"});this.toast=$({tag:"div",className:"toast-"+this.id,style:$.STYLE_BODY+"position:relative;z-index:10000;width:"+this.options.width+"px;height:"+this.options.height+"px;margin-left:"+($(window).width()-this.options.width)/2+"px;margin-top:"+-this.options.height+"px;background-color:none;border-radius:5px;font-size:16px;color:white;text-align:center;line-height:"+this.options.height+"px"});this.toast.html(html);this._create();this._funcResize=function(){self.resize()};this._funRemove=function(){self.remove()};$(window).addEvent("resize",this._funcResize)},_create:function(){this.toastOpacity.appendTo(document.body);this.toast.appendTo(document.body)},change:function(html){$(".toast-"+this.id).html(html)},resize:function(){var width=$(window).width();var height=$(window).height();var left=(width-this.options.width)/2>0?(width-this.options.width)/2:0;var top=(height-this.options.height-100)/2>0?$(window).scrollTop()+(height-this.options.height-100)/2:$(window).scrollTop();$(".toast-opacity-"+this.id).css({"margin-left":left+"px","margin-top":top+"px","max-width":width+"px","max-height":height+"px"});$(".toast-"+this.id).css({"margin-left":left+"px","margin-top":-this.options.height+"px","max-width":width+"px","max-height":height+"px"})},remove:function(){$(".toast-opacity-"+this.id).remove();$(".toast-"+this.id).remove()}};$.GifTimer=$.Class.create();$.GifTimer.prototype={id:null,inter:null,timeout:null,options:{inTimeFunc:null,outTimeFunc:null,doTime:null,allTime:null},initialize:function(options){var self=this;this.options=$.extend(this.options,options);this.inter=setInterval(function(){self.options.inTimeFunc.call(self)},this.options.doTime);this.timeout=setTimeout(function(){clearInterval(self.inter);self.options.outTimeFunc.call(self)},this.options.allTime)},remove:function(){$.Log("giftimer remove");clearInterval(this.inter);clearTimeout(this.timeout);this.inter=null;this.timeout=null}};$.Music=$.Class.create();$.Music.prototype={msgid:null,url:null,type:null,duration:null,audioFlag:true,musicEl:null,viewCallback:null,eventCallback:null,container:null,debugStr:"[nTalk Music]: ",initialize:function(msgid,url,type,duration,viewCallback,eventCallback,container){this.msgid=msgid;this.url=url;this.type=type;this.duration=duration;this.viewCallback=viewCallback;this.eventCallback=eventCallback;this.container=container;this.audioFlag=this.canPlayAudioMP3();if(this.audioFlag){this.createAudioPlayer()}else{this.createSwfPlayer()}this.viewCallback.call(this,"init");this.eventCallback.call(this,"init")},createAudioPlayer:function(){var self=this;this.musicEl=document.createElement("audio");this.musicEl.src=this.url;this.musicEl.type=this.type;this.musicEl.stop=function(){this.pause();this.currentTime=0};$.Event.addEvent(this.musicEl,"ended",function(){$.Log(self.debugStr+" trigger ended stop mp3");self.viewCallback.call(self,"stop")});this.musicEl.getPaused=function(){return this.paused}},createSwfPlayer:function(){var self=this;var musicId="ntalker_swf_mp3Player_container_"+this.msgid;var id="ntalker_swf_mp3player_"+this.msgid;var swf=$.sourceURI+"fs/music.swf";var html=$.flashHtml(id,swf,"id="+id);this.musicEl=document.createElement("div");this.musicEl.innerHTML+=html;this.musicEl.id=musicId;this.container.append(this.musicEl.outerHTML);var flashEl=$.browser.msie&&$.browser.ieversion<=7?window[id]:document[id];setTimeout(function(){flashEl.emit("load",self.url);flashEl.emit("stop");self.musicEl.play=function(){flashEl.emit("play")};self.musicEl.stop=function(){flashEl.emit("stop")};self.musicEl.getPaused=function(){return flashEl.getPaused()===0}},1e3)},emit:function(){if(this.musicEl.getPaused()){this.play()}else{this.stop()}},play:function(){$.Log(this.debugStr+"play mp3");this.musicEl.play();this.viewCallback.call(this,"play")},stop:function(){$.Log(this.debugStr+"stop mp3");this.musicEl.stop();this.viewCallback.call(this,"stop")},canPlayAudioMP3:function(){try{var a=document.createElement("audio");return!!(a.canPlayType&&a.canPlayType("audio/mpeg;").replace(/no/,""))}catch(e){return false}}};$.paste=$.Class.create();$.paste.prototype={data:null,callback:null,debugStr:"[nTalk pasteDate]: ",initialize:function(pasteEvent,callback){this.data=pasteEvent.clipboardData||window.clipboardData;this.callback=callback},getImgBase64Str:function(){var self=this,data=this.data;if(!data){return null}if(typeof webInfoChanged=="function"){this.callback(data.getData("image/x-vnd.adobe.air.bitmap").toDataURL())}else if($.browser.chrome||$.browser.opera||$.browser.firefox){var item,types,items=data.items;if(items){item=items[0];types=data.types||[];for(var i=0,l=types.length;i<l;i++){if(types[i]==="Files"){item=items[i];break}}if(item&&item.kind==="file"&&item.type.match(/^image\//i)){var blob=item.getAsFile(),reader=new FileReader;reader.onload=function(e){self.callback(e.target.result)};reader.readAsDataURL(blob)}else{this.callback()}}}else{this.callback()}}}})(nTalk);
/* @file im.js
 * @date 2018.03.06 15:08:26 
 */
(function($,undefined){var CON_FLASH_DIV="nTalk-flash-element",CON_IM_ID="ntkf_flash_impresence",CON_IM_FIX="IM_",CON_DATA_FIX="JDATA_",CON_PCID_KEY="machineid",CON_CURRENT_PAGE=CON_IM_FIX+"CURRENT_PAGE",CON_CUREENT_CONNECT=CON_IM_FIX+"CUREENT_CONNECT",CON_PAGE_DATA=CON_IM_FIX+"SEND_CURRENT_PAGE_DATA",CON_STYLE_PUBLIC_CONTENT="margin:0;padding:0;border:none;float:none;font:normal normal normal 12px/160% Arial,SimSun;",CON_EXIST_PAGEARR=CON_IM_FIX+"EXIST_PAGEARR";if($.im){return}$.tipsicon=$.sourceURI+"images/tipsicon."+($.browser.msie6?"gif":"png");$.extend({CON_LCRM_FIX:"LCRM_",currentCount:0,im:{connect:null,time:3,args:null,options:null,tipElement:null,receiveMsgCount:0,isInvite:false,start:function(){var self=this;if(this.connect){$.Log("im connected",2);return}this.options={siteid:$.global.siteid,settingid:$.global.settingid,surl:$.server.flashserver,r:$.baseURI,ref:$.referrer,fsid:$.global.trailid,cid:$.global.pcid,presenceserver:$.server.presenceserver,presencegoserver:$.server.presencegoserver,t2dstatus:$.server.t2dstatus,crmcenter:$.server.crmcenter,coopserver:$.server.coopserver,loadnid:$.CON_LOAD_MODE_NID};if($.user.id){this.options=$.merge(this.options,$.whereGet($.user,["id","name"],["u","n"]))}$.require({comet:"nt2.js?siteid="+$.extParmas.siteid},function(comet){if(!comet){$.Log("Loaded $comet mode failed",3);return}self.connect=new $.connectPresence(self.options,$.server.close_im_flash||"0",$.server.tchatConnectType);$.IMPRESENCE=self.connect;$.promptwindow.callbackFocus=function(){self.onPageFocus()};$.promptwindow.callbackBlur=function(){self.onPageBlur()};$.listenMouseOutEvent();setInterval(function(){self.intervalVerify()},5e3);$.moveCheck=setInterval(function(){if($.moveTime===0&&$.currentCount==1&&$.moveCheckFlag){$.moveCheckFlag=false;setTimeout(function(){if($.moveTime===0&&$.currentCount==1){$.showBeforeLeavePlan()}$.moveCheckFlag=true},2*1e3)}},1*1e3)})},callReceiveSysMessage:function(data,message,inviteid){var chat,settingid,destid,sellerid;$.Log("im.callReceiveSysMessage("+$+")");destid=data.id||"";if(!data.settingid&&destid){sellerid=destid.split("_").splice(0,2).join("_");data.settingid=$.global.settingid.indexOf(sellerid)>-1||sellerid.indexOf("kf_")?$.global.settingid:sellerid+"_9999"}$.Log("$.IM.callReceiveSysMessage("+$.JSON.toJSONString(arguments)+")",2);if($.isEdu){if($.global.callbacks["ReceiveOfflineMessage"]){var runJson={id:data.id,settingid:data.settingid,name:data.name,userIcon:data.userIcon,message:message};$.base.fire("ReceiveOfflineMessage",[runJson])}else if($.browser.mobile){if(inviteid){$.im_openInPageChat("","",inviteid.wid,{edu_inviteid:inviteid.inviteid,edu_visitid:inviteid.visitid});$.fim_offlineMssage(message,inviteid,data);return}else if(data){$.fim_offlineMssage(message,inviteid,data)}else{return}return}else{if(inviteid){nTalk.im_openInPageChat("","",inviteid.wid,{edu_inviteid:inviteid.inviteid,edu_visitid:inviteid.visitid});return}else if(data){$.im.showTips(data,message)}else{return}}return}switch(data.calltype){case 10:if($.global.callbacks["ReceiveOfflineMessage"]){var runJson={id:data.id,settingid:data.settingid,name:data.name,userIcon:data.userIcon,message:message};$.base.fire("ReceiveOfflineMessage",[runJson])}else if($.browser.mobile&&$.global.pageinchat){if($.isFunction(im_receiveMessage)){im_receiveMessage(data.settingid,message)}}else if($.chatManage&&(chat=$.chatManage.get(data.settingid,destid))){chat.reconnect(null,destid,-1);$.chatManage.callReceive(chat.settingid)}else if($.server.isnoim==3){$.im_openInPageChat(data.settingid,"",destid,{single:-1,autoconnect:true},"")}else{if(nTalk.global.siteid==data.eid||$.inArray(data.eid,$.global.sellerid)>-1){$.im.showTips(data,message)}}break;case 1:case 2:$.base.startLCrm(data.content);break;default:if($.global.callbacks["ReceiveOfflineMessage"]){var runJson={id:data.id,settingid:data.settingid,name:data.name,userIcon:data.userIcon,message:message};$.base.fire("ReceiveOfflineMessage",[runJson])}else if(data.autoOpen||$.server.isnoim==3){if($.im){$.im.refuseInvite(destid,data.inviteid,0)}if($.chatManage&&(chat=$.chatManage.get(data.settingid,destid))){chat.reconnect(null,destid,-1);$.chatManage.callReceive(chat.settingid)}else if($.im_openInPageChat){$.im_openInPageChat(data.settingid,"",destid,{single:-1,autoconnect:1},"")}}else{this.showTips(data,message,true)}break}},onPageFocus:function(){$.IMPRESENCE.setPageFocus(true,$.title,$.url,0);this.intervalVerify()},onPageBlur:function(){$.IMPRESENCE.setPageFocus(false)},intervalVerify:function(){var cacheData,tmpData;cacheData=$.loadLCrm();$.each(cacheData,function(index,data){if(data.trigger==1||!$.im.connect.currentPage.get()){return}tmpData=$.extend(data,{cw:$.currentCount});$.base.startLCrm(tmpData,false,true);$.flashData.remove($.CON_LCRM_FIX+tmpData.token)})},showTips:function(data,txtMessage,isInvite){var arrtmp;this.settingid=data.settingid||$.global.settingid||"";this.destid=data.id||"";this.sessionid=data.sid||"";this.inviteid=data.inviteid||"";this.isInvite=isInvite;if(typeof window.webInfoChanged=="function"){webInfoChanged(400,'{"num":'+ ++this.receiveMsgCount+', "showNum":1}',false)}arrtmp=this.destid.split("_ISME9754_T2D_");this.sellerid=arrtmp[0].indexOf("kf_")>-1||arrtmp[0]==$.global.siteid?"":arrtmp[0];$.require($.tipsicon,function(image){if(image.error)$.Log("cache chat icon failure",3)});this._createTips();this.tipElement.find(".ntalk-tips-body").html(txtMessage);this.tipElement.find(".ntalk-tips-button").html($.lang.tip_prompt||"立刻咨询");$.promptwindow.startPrompt("",$.lang.news_new,true)},hideTips:function(){var self=this;if(!this.tipElement||!this.tipElement.length){return}this.tipElement.hide(500,function(){$(this).remove();self.tipElement=null})},openChat:function(){this.hideTips();if($.browser.mobile||!$.global.pageinchat){$.im_openOutPageChat(this.settingid,"",this.destid,{manual:1},"",this.sellerid)}else{$.im_openInPageChat(this.settingid,"",this.destid,{single:-1,autoconnect:this.isInvite?-1:1,manual:1},"")}},_createTips:function(){var self=this;if(!this.tipElement||!this.tipElement.length){var ntalkTipStyle=$.lang.tip_prompt=="立刻咨询"||$.lang.tip_prompt=="立即咨詢"?"left:105px;width:69px;":"left:67px;width:130px;";var html=['<div class="ntalk-tips-background" style="margin:0;padding:10px;border:0;background:url(',$.tipsicon,') no-repeat 0 0;color:#333333;font:normal 12px/160% Arial,SimSun;text-align:left;height:150px;width:205px;">','<div class="ntalk-tips-body" style="margin:0;padding:0;border:0;float:left;font:normal 12px/160% Arial,SimSun;color:#333;height:60px;overflow:hidden;text-align:left;white-space:normal;width:156px;word-break:break-all;"></div>','<div class="ntalk-tips-close" style="background:url(',$.tipsicon,') no-repeat -7px -120px;margin:5px;padding:0;border:0;cursor:pointer;font:normal 1px/1px Arial;height:20px;left:166px;position:absolute;top:0px;width:20px;"></div>','<div class="ntalk-tips-button" style="background:#008CD4;margin:0;padding:0;border:0;color:#FFFFFF;cursor:pointer;height:24px;font:normal 12px/24px Arial,SimSun;position:absolute;text-align:center;top:78px;',ntalkTipStyle,'"></div>',"</div>"].join("");this.tipElement=$({className:"ntalk-tips-container",style:CON_STYLE_PUBLIC_CONTENT+"width:206px;height:112px;z-index:99999;"}).appendTo(true).fixed({right:0,bottom:0}).html(html);this.tipElement.click(function(event){$.Event.fixEvent(event).stopPropagation();self.openChat()});this.tipElement.find(".ntalk-tips-button").click(function(event){$.Event.fixEvent(event).stopPropagation();self.openChat()}).hover(function(event){$(this).css("background","#007AB9")},function(event){$(this).css("background","#008CD4")});this.tipElement.find(".ntalk-tips-close").click(function(event){$.Event.fixEvent(event).stopPropagation();self.hideTips()}).hover(function(event){$(this).css("background-position","-27px -120px")},function(event){$(this).css("background-position","-7px -120px")})}},refuseInvite:function(destid,inviteid,status){if(!$.server.presencegoserver){$.Log("presencegoserver is null",2);return}if(!destid||!inviteid){$.Log("auto invite",1);return}if($.global.callbacks["AcceptInvitation"]&&status==1){$.base.fire("AcceptInvitation",[])}else if($.global.callbacks["RefuseInvitation"]&&(status==0||status==2)){$.base.fire("RefuseInvitation",[])}var params={action:"",query:"invtrst",suid:$.user.id,duid:destid,rst:status,invid:inviteid,tk:$.global.userToken};$.require($.server.presencegoserver+"?"+$.toURI(params)+"#rnd")}}});$.extend({listenMouseEvent:false,lcrmGoAwayClientY:0,lcrmGoAwayView:false,moveTime:0,moveCheck:null,moveCheckFlag:true,loadLCrm:function(){var data=$.flashData.get(),result={};for(var name in data){if(typeof data[name]=="function")continue;if(data[name]&&name.indexOf($.CON_LCRM_FIX)>-1){result[name]=data[name]}}return result},listenMouseOutEvent:function(remove){var self=this,_mouseover=function(e){var event=$.Event.fixEvent(e);if((event.relatedTarget||event.toElement)&&!self.lcrmGoAwayView){self.setMouseOutWindow(event,false)}},_mouseout=function(e){var event=$.Event.fixEvent(e);if(!(event.relatedTarget||event.toElement)){self.setMouseOutWindow(event,true);self.moveTime=0}},_mousemove=function(e){var event=$.Event.fixEvent(e);self.setMouseOutWindow(event,"mousemove");if($.moveCheck!==null){$.moveCheck=null}self.moveTime=$.getTime()};if(this.listenMouseEvent||$.browser.mobile){return}this.listenMouseEvent=true;if(remove===true){$(document).removeEvent("mouseover",_mouseover);$(document).removeEvent("mouseout",_mouseout);$(document).removeEvent("mousemove",_mousemove)}else{$(document).addEvent("mouseover",_mouseover);$(document).addEvent("mouseout",_mouseout);$(document).addEvent("mousemove",_mousemove)}},setMouseOutWindow:function(event,goAwayView){var self=this;if(goAwayView==="mousemove"){this.lcrmGoAwayClientY=event.clientY>0?event.clientY:this.lcrmGoAwayClientY;return}this.lcrmGoAwayView=goAwayView;if(event.clientY<0&&self.lcrmGoAwayClientY<50){if($.currentCount!=1){return}setTimeout(function(){if($.moveTime===0){$.showBeforeLeavePlan()}},.5*1e3)}},_getExistPageList:function(){try{return $.store.get(CON_EXIST_PAGEARR).split(",")}catch(e){return[]}},showBeforeLeavePlan:function(){var cache,tmpData;cache=$.loadLCrm();$.each(cache,function(index,data){if(data.trigger===0){return}tmpData=$.extend(data,{trigger:0,cw:$.currentCount});$.base.startLCrm(tmpData,false,true);$.flashData.remove($.CON_LCRM_FIX+tmpData.token)})}});$.extend({fIM_onPresenceReceiveSysMessage:function(type,message){$.Log('$.fIM_onPresenceReceiveSysMessage("'+type+'", "'+$.JSON.toJSONString(message)+'")',1);setTimeout(function(){var json,textMessage,strJson,inviteid;if(message.indexOf("ntalker://")>-1){textMessage=$.clearHtml(message.substr(0,message.indexOf("ntalker://")));strJson=message.substr(message.indexOf("ntalker://")+10)}else{var arr=message.split("&&");var strJson=null;var strinviteid=null;for(var i=0;i<arr.length;i++){arr[i].indexOf("msg=")>-1?strJson=arr[i].replace("msg=",""):strinviteid=arr[i].replace("inviteid=","")}}try{json=$.JSON.parseJSON(strJson);if(strinviteid){inviteid=$.JSON.parseJSON(strinviteid)}}catch(e){$.Log("nTalk.fIM_onPresenceReceiveSysMessage():"+e.message,3);return}$.im.callReceiveSysMessage(json,textMessage,inviteid)},0);return true},fIM_onGetFlashServer:function(userInfoUrl,trailUrl,historicalMsgUrl,checkURL,avServer,manageServer,fileServer){return true},connectStatus:-1,fIM_updateUserStatus:function(state,strMessage){setTimeout(function(){$.Log("$.fIM_updateUserStatus("+state+', "'+strMessage+'")');$.connectStatus=state;if($.connectStatus==2){try{$.IMPRESENCE.setPageFocus(true,$.title,$.url,1)}catch(e){$.Log(e,3)}}},0);return true},fIM_presenceSetIMSid:function(userToken){$.Log("fIM_presenceSetIMSid(userToken:"+userToken+")",1);$.global.userToken=userToken;return true},fIM_presenceSetMyClientID:function(presenceFlashGoUrl){$.url_presenceFlashGoUrl=presenceFlashGoUrl;return true},flashData:{debug:false,reNumber:0,sessionData:null,checkFlash:function(fn){if(!$.IMPRESENCE||!$.isFunction($.IMPRESENCE.setJSData)){if(this.reNumber>3){return}this.reNumber++;setTimeout(fn,500)}else fn.call(this)},add:function(k,data){var self=this;if(data){data=this.filter($.JSON.toJSONString(data),true)}if(this.debug){$.Log("$.flashData.add(k:"+k+", v:"+data+")",1)}this.checkFlash(function(){try{$.IMPRESENCE.setJSData($.global.trailid,k,data);return true}catch(e){return false}})},remove:function(k){this.add(k,null,false)},clearAll:function(){this.checkFlash(function(){try{NTKF.IMPRESENCE.setJSData("","","");return true}catch(e){return false}})},get:function(key){var data,ret={};if(!$.IMPRESENCE||!$.IMPRESENCE.getJSData)return ret;data=$.IMPRESENCE.getJSData($.global.trailid,key||"");try{data=$.JSON.parseJSON(data)}catch(e){}if(typeof data=="string"){ret=$.JSON.parseJSON(this.filter(data,false)||"{}")}else{for(var k in data){if($.isFunction(data[k]))continue;try{ret[k]=$.JSON.parseJSON(this.filter(data[k],false))}catch(e){}}}return ret},filter:function(data,replace){return replace===true?data.replace(/\"/gi,"{sy}"):data.replace(/\{sy\}/gi,'"')}},fim_offlineMssage:function(message,data,json,boolean){if($(".nTalk-window-offLine").length==0){$.OfflineChat=new nTalk.ChatOfflineChat(data,json)}if(!message&&!data&&!json&&boolean){$.OfflineChat.count=0;$.cache.set("imcount",0);$.OfflineChat.offlineChatCount.css("display","none").html("0");$.OfflineChat.offlineChat.css("display","none");return}$.OfflineChat.receiveMessage(message,"",json)}});$.connectPresence=$.Class.create();$.connectPresence.prototype={name:"connectPresence",options:null,manage:null,debug:false,data:null,switchTimeId:null,_connected:false,currentConnectType:"",initialize:function(options,close_im_flash,connect_type){var self=this,manageOptions,conType;this.data=$.store;this.options=$.extend({nullparam:"",usemqtt:0},options);if(connect_type==1&&$.server.eduimmqttserver){this.connect=this._createMqttConnect(this.options)}else{this.connect=this._createCometConnect(this.options)}$.Log("new $.connectPresence(); connect_type: "+connect_type+", isnoim:"+$.server.isnoim);if(!this.connect.manage){this.manage=new $.pageManage}else{this.manage=this.connect.manage}this.manage.options.onChanage=function(count,data){$.currentCount=count;$.Log("page manage callback: current open window number:"+$.currentCount,1)};$.currentCount=this.manage.count;this.identid=this.manage.identid;if(!this.connect.currentPage){$.Log("new $.CurrentPage("+this.identid+")",1);this.currentPage=new $.CurrentPage(this.identid,this.manage)}else{this.currentPage=this.connect.currentPage}},switchConnect:function(){this.stopSwitchConnect();if(this.currentConnectType!=$.CON_CONNECT_COMET){$.Log("Flash abnormalities, switch the connection type. this.currentConnectType:"+this.currentConnectType+" > comet",2);if(this.connect&&$.isFunction(this.connect.remove)){$.flash.remove(this.connect)}if(this.connect&&$.isFunction(this.connect.disconnect)){this.connect.disconnect()}}else{$.Log("Flash abnormalities",2)}},stopSwitchConnect:function(){clearTimeout(this.switchTimeId);this.switchTimeId=null},setPageFocus:function(focus,title,url,other){if(focus){this.currentPage.set(title,url)}},closePresence:function(){if(this.connect){try{this.connect.closePresence()}catch(e){}}if(this.currentConnectType==$.CON_CONNECT_FLASH){$.flash.remove(this.connect)}this.connect=null;this.manage=null},setJSData:function(trailid,key,value){var ret;trailid=arguments[0];if(!trailid||trailid===""){ret=this.data.getAll();for(var k in ret){if(!ret.hasOwnProperty(k))continue;if(k.indexOf(CON_DATA_FIX)>-1){this.data.remove(k)}}}else{key=CON_DATA_FIX+trailid+"-"+arguments[1];this.data.set(key,arguments[2])}},getJSData:function(trailid,key){var ret,result={};ret=this.data.getAll();for(var k in ret){if(typeof ret[k]=="function")continue;if(k.indexOf(CON_DATA_FIX)>-1){result[k]=ret[k]}}return $.JSON.toJSONString(result)},_createFlashConnect:function(options){$.Log("$.connectPresence._createFlashConnect()",1);var flashdiv=$("#"+CON_FLASH_DIV),flashsrc=$.sourceURI+"fs/impresence.swf?"+$.version.im,flashhtml=$.flashHtml(CON_IM_ID,flashsrc,options);this.currentConnectType=$.CON_CONNECT_FLASH;if(!flashdiv.length){flashdiv=$(document.body).insert('<div id="'+CON_FLASH_DIV+'" class="nTalk-hidden-element" style="position: absolute; z-index: 9996; top: -200px;"></div>')}flashdiv.insert(flashhtml);if($.browser.msie){flashdiv.find("#"+CON_IM_ID).display(1)}return flashdiv.find("#"+CON_IM_ID).get(0)},_createCometConnect:function(options){$.Log("$.connectPresence._createCometConnect()",1);this.currentConnectType=$.CON_CONNECT_COMET;return new $.IMPresence(options)},_createMqttConnect:function(options){$.Log("$.connectPresence._createMqttConnect()",1);this.currentConnectType=$.CON_CONNECT_COMET;return new $.IMConnection.Presence(options)}};$.IMPresence=$.Class.create();$.IMPresence.prototype={name:"IMPresence",options:null,connectParams:["userid","username","token","sessionid","nullparam","nullparam","nullparam","siteid","nullparam","nullparam","connectType","pcid","nullparam"],connect:null,debug:false,login:false,currentPage:null,_reCount:0,_waitTime:500,_currentConnected:false,_waitReconnectTimeID:null,_mqttFlag:true,initialize:function(options){var self=this;this._wsFlag=options.usemqtt==1?true:false;this.options=$.extend({nullparam:""},$.whereGet(options,["siteid","settingid","cid","surl","u","n","s","r","ref","fsid"],["siteid","settingid","pcid","serverurl","userid","username","sessionid","resourceurl","referrer","flashsessionid"]));this.data=$.store;this._reCount=0;if(!this.options.pcid||this.options.pcid.length<=10){this.options.pcid=this.data.get(CON_PCID_KEY);if(!this.options.pcid||this.options.pcid.length<=10){this.options.pcid=$.base._createScriptPCID()}}try{this.data.set(CON_PCID_KEY,this.options.pcid)}catch(e){$.Log(e,3)}if(!this.options.userid){this.options.userid=$.base.userIdFix+this.options.pcid.substr(0,21)}this._callback("fIM_presenceFlashReady",[this.options.userid,this.options.pcid]);var manageOptions={onInterval:function(timeout,manageData){self._onInterval.call(self,timeout,manageData)},onChanage:function(count,data){self._onChanage.call(self,count,data)}};this.manage=new $.pageManage(manageOptions);this.identid=this.manage.identid;this.currentPage=new $.CurrentPage(this.identid,this.manage);this.setPageFocus(true,$.title,$.url)},loginConnect:function(){var self=this,wsUrl="",arrConnectParams=this._toArray(this.options,this.connectParams);if(this.debug)$.Log("im.loginConnect()");this._callback("fIM_updateUserStatus",[1,""]);if($.server.presenceserver){var urlArr=$.server.presenceserver.split(";");for(var i=0;i<urlArr.length;i++){if(urlArr[i].indexOf("ws://")>-1){wsUrl=urlArr[i]}}}else{return}if(!wsUrl){this._wsFlag=false}if(this._wsFlag){this.connect=new $.mqttws({url:wsUrl,siteid:self.options.siteid,pcid:self.options.pcid,onCallback:function(){self._onCallback.apply(self,arguments)},loginMsg:$.JSON.toJSONString({method:"roomConnect",params:arrConnectParams})})}else{this.connect=new $.comet($.server.presencegoserver,{timeout:20,onCallback:function(){self._onCallback.apply(self,arguments)},onComplete:function(event){self._onComplete.apply(self,arguments)},onAbnormal:function(event){self._onAbnormal.apply(self,arguments)},onTimeout:function(event){self._onTimeout.apply(self,arguments)}});this.connect.connect({action:"conn",params:arrConnectParams.join(",")},"callback")}},kaliveConnect:function(){if(this.debug)$.Log("$.IMPresence.kaliveConnect()",1);var self=this;var connectOptions;if(this._wsFlag){connectOptions={method:"remoteKeepAlive",params:[null,this.options.userid,this.options.clientid]};this.connect.kalive($.JSON.toJSONString(connectOptions))}else{var arrConnectParams=this._toArray(this.options,this.connectParams);connectOptions={action:"kalive",params:arrConnectParams.join(","),clientid:this.options.clientid,machineid:this.options.pcid,token:this.options.token,uid:this.options.userid};setTimeout(function(){self.connect.kalive(connectOptions,"callback")},1e3)}},reconnect:function(){var self=this;if(++this._reCount<=3){this._waitTime=500}else{this._waitTime=+"034567890".charAt(Math.ceil(Math.random()*5))*1e3}if(this.debug)$.Log("$.IMPresence.reconnect() wait:"+this._waitTime,1);this._waitReconnectTimeID=setTimeout(function(){self.connect.reconnect()},this._waitTime)},disconnect:function(){var ret=this.data.getAll();for(var k in ret){if(typeof ret[k]=="function")continue;if(k.indexOf(CON_DATA_FIX)>-1){this.data.remove(k)}}clearTimeout(this._waitReconnectTimeID);this._waitReconnectTimeID=null},LoginResult:function(login,userid,clientid,token){this.login=login;this.options.clientid=clientid;this.options.token=token;this._callback("fIM_updateUserStatus",[this.login?2:0,""]);this._callback("fIM_presenceSetIMSid",[this.login?this.options.token:""]);if(this.login){this.kaliveConnect("call kalive")}else{this.reconnect("login relogin")}},remoteNotifyChatWithGroup:function(param1,param2,param3,destuid,destuname,destlogo,msg,time){var json,message,protocol;if(!msg){if(this.debug)$.Log("message content is null",3);return}message=$.clearHtml(msg.substr(0,msg.indexOf("ntalker://")));protocol=msg.substr(msg.indexOf("ntalker://")+10);try{json=$.JSON.parseJSON(protocol)}catch(e){}if($.store.isStorageSupported){this._sendMessage2CurrenPage(message+"ntalker://"+protocol)}else{this._callback("fIM_onPresenceReceiveSysMessage",[1,message+"ntalker://"+protocol])}},remoteNotifyUserCode:function(args){$.Log("do remoteNotifyUserCode!!!")},remoteConfirmAddFriend:function(args){$.Log("do remoteConfirmAddFriend")},_handleResponse:function(methodName,methodParams){if(this[methodName]){this[methodName].apply(this,methodParams)}else{$.Log("The object of the method '"+methodName+"' does not exist",3)}},_callback:function(methodName,methodParams){if($.hasOwnProperty(methodName)){try{$[methodName].apply(this,methodParams)}catch(e){}}else{$.Log("nTalk."+methodName+"(...)",2)}},_onCallback:function(isCurrentCallBack,args){var self=this,method;if(this.debug)$.Log("$.IMPresence.onCallback(  )");if(!args.length){return}method=args[0];if(/LoginResult|LoginReslut/gi.test(method)){if(!isCurrentCallBack){return}else{this.LoginResult.apply(self,args.slice(1))}}else{this._handleResponse.call(self,method,args.slice(1));if(isCurrentCallBack){this.kaliveConnect("call kalive")}}},_onComplete:function(){var args=Array.prototype.slice.call(arguments);if(this.debug)$.Log("$.IMPresence.onComplete( "+args[0]+","+args[1]+","+args[2]+" )");if(args[0]=="kalive"){this.kaliveConnect("complete kalive")}else if(args[0]=="login"){this.reconnect("abnormal login")}},_onAbnormal:function(){var args=Array.prototype.slice.call(arguments);if(this.debug)$.Log("$.IMPresence.onAbnormal( "+args[0]+","+args[1]+","+args[2]+" )",3);if(args[0]=="login"){this.reconnect("abnormal login")}else{this.kaliveConnect("abnormal kalive")}},_onTimeout:function(){var args=Array.prototype.slice.call(arguments);if(this.debug)$.Log("$.IMPresence.onTimeout( "+args[0]+","+args[1]+","+args[2]+" )",3);if(args[0]=="login"){this.reconnect("time login")}else{this.kaliveConnect("timeout kalive")}},_onInterval:function(timeout,m){var diff;this.currentConn=this.data.get(CON_CUREENT_CONNECT)||{identid:"",time:0};if(this.currentConn.identid&&this.currentConn.identid===this.identid){this.currentConn.time=$.getTime();this.data.set(CON_CUREENT_CONNECT,this.currentConn);this._fireEvent("update")}else{var exists;if($.isArray(m)){for(var i=0;i<m.length;i++){page=m[i];if(page&&page[this.currentConn.identid]){exists=true;this._currentConnected=true}}}if(this.currentConn.identid&&this.currentConn.identid!==this.identid&&!exists){this.currentConn.identid="";this._currentConnected=false;this._fireEvent("clear")}if(this.debug)$.Log("currentConnect>>_onInterval:"+$.JSON.toJSONString(this.currentConn)+", _currentConnected:"+this._currentConnected);if((!this.currentConn.identid||this.currentConn.identid==="")&&!this._currentConnected){this.currentConn={identid:this.identid,time:$.getTime()};this._currentConnected=true;try{this.data.set(CON_CUREENT_CONNECT,this.currentConn)}catch(e){$.Log(e,3)}this._fireEvent("add");this.loginConnect()}else{this._fireEvent("wait")}}},_onChanage:function(pageCount,data){this.pageCount=pageCount;return},_fireEvent:function(type){if(this.temp==1||!this.temp){this.temp=1;if(this.debug&&type!=="wait"){$.Log(this.identid+", "+type+" long connect, curPage:"+this.currentPage.get(),2)}}else if(this.temp>=5)this.temp=0;this.temp++;this._currentGetMessage()},_toArray:function(json,arr){var result=[];if(!json){return"error"}for(var i=0;i<arr.length;i++){result.push(json[arr[i]]||"")}return result},_sendMessage2CurrenPage:function(message){var self=this,objectQueue,strdata=this.data.get(CON_PAGE_DATA);if(!message)return;if(!this.Queue){this.Queue=new $.Queue}if(strdata){this.Queue.enQueue({data:message})}else{this.data.set(CON_PAGE_DATA,message)}},_currentGetMessage:function(){var callCurrentPageData=this.data.get(CON_PAGE_DATA);if(!callCurrentPageData){return}try{callCurrentPageData=$.JSON.parseJSON(callCurrentPageData)}catch(e){}if(!this.currentPage.get()||!callCurrentPageData){return}this.data.remove(CON_PAGE_DATA);this._callback("fIM_onPresenceReceiveSysMessage",[1,callCurrentPageData]);if(!this.Queue){return}var objectQueue=this.Queue.deQueue();if(objectQueue){this._sendMessage2CurrenPage(objectQueue.data)}},setPageFocus:function(focus,title,url,other){if(focus===true){this.currentPage.set(title,url)}},closePresence:function(){if(this._wsFlag){this.connect.disconnect()}else{try{this.cometd.disconnect(true)}catch(e){}}this.data.remove(CON_CUREENT_CONNECT)},setJSData:function(){var ret,key,trailid=arguments[0];if(!trailid||trailid===""){ret=this.data.getAll();for(var k in ret){if(typeof ret[k]=="function")continue;if(k.indexOf(CON_DATA_FIX)>-1){this.data.remove(k)}}}else{key=CON_DATA_FIX+trailid+"-"+arguments[1];this.data.set(key,arguments[2])}},getJSData:function(){var ret,result={},key=Array.prototype.slice.call(arguments,0,2).slice(0,2).join("-");if(key&&arguments[1])return $.JSON.toJSONString(this.data.get(key));else{ret=this.data.getAll();for(var k in ret){if(typeof ret[k]=="function")continue;if(k.indexOf(CON_DATA_FIX)>-1){result[k]=ret[k]}}return $.JSON.toJSONString(result)}}};$.CurrentPage=$.Class.create();$.CurrentPage.prototype={name:"CurrentPage",cachePageData:null,identid:"",debug:false,manage:null,initialize:function(identid,objManage){if(!identid){$.Log("$.CurrentPage params failed",3);return}this.identid=identid;this.manage=objManage;this.data=$.store},set:function(title,url){if(!title||!url){$.Log("title is null, url is null");return false}this.cachePageData={identid:this.identid,title:title,url:url};if(this.debug){$.Log("$.CurrentPage.set():"+$.JSON.toJSONString(this.cachePageData),1)}this.data.set(CON_CURRENT_PAGE,this.cachePageData)},get:function(){var page,exists=false;this.cachePageData=this.data.get(CON_CURRENT_PAGE);if(!this.cachePageData||$.isEmptyObject(this.cachePageData)){return false}var pageList=$._getExistPageList();if(pageList.length>0){for(var i=0;i<pageList.length;i++){page=pageList[i];if(page==this.cachePageData.identid){exists=true;break}}if(exists===false){if(this.identid==pageList[pageList.length-1]){this.set($.title,$.url);return true}}}if(this.debug){$.Log("::"+$.JSON.toJSONString(this.cachePageData));$.Log("cache page identid:"+this.cachePageData.identid+", identid:"+this.identid+", currentPage: "+(this.cachePageData.identid==this.identid))}try{if(this.cachePageData.identid==this.identid){return true}else return false}catch(e){return false}}};$.ChatOfflineChat=$.Class.create();$.ChatOfflineChat.prototype={name:"ChatOfflineChat",speed:0,times:2e3,fontSize:1,times:1,running:false,backGround:null,chatWidth:null,chatHeight:null,arrList:[],inviteid:"",visitid:"",wid:"",count:0,store:false,eduStoreInfo:{},initialize:function(options,json){if(window.localStorage){this.store=true}if($.browser.mobile&&$("meta[name=viewport]").length==0){this.fontSize=2}if(options){this.inviteid=options.inviteid;this.visitid=options.visitid;this.wid=options.wid}else{this.wid1=json.id}var icon=json.userIcon?json.userIcon:json.usericon?json.usericon:json.logo;var name=json.externalname?json.externalname:json.name;this.offlineChat=$({tag:"div",className:"nTalk-window-offLine",style:"width:94%;height:"+106*this.fontSize+"px;background:-webkit-gradient(linear,center top,center bottom,from(#ffffff), to(#ffffff));position:fixed;left:3%;bottom:"+75*this.fontSize+"px;box-sizing:border-box;padding:"+10*this.fontSize+"px "+10*this.fontSize+"px;box-shadow:0 0 "+10*this.fontSize+"px "+2*this.fontSize+"px #bababa;z-index:10000;border-radius:"+3*this.fontSize+"px;"}).appendTo(true);this.offlineChatAngle=$({tag:"div",className:"nTalk-window-offline-angle",style:"width:0;height:0;border:"+20*this.fontSize+"px solid #fff;position:absolute;bottom:-"+20*this.fontSize+"px;right:"+10*this.fontSize+"px;border-top:"+10*this.fontSize+"px solid #fff;border-left:"+5*this.fontSize+"px solid transparent;border-right:"+5*this.fontSize+"px solid transparent;border-bottom:"+10*this.fontSize+"px solid transparent;"}).appendTo(this.offlineChat);this.offlineChatLogo=$({tag:"div",className:"nTalk-window-offLine-logo",style:"width:100%;height:"+24*this.fontSize+"px;background:transparent;float:left;"}).appendTo(this.offlineChat);this.headerLogo=$({tag:"img",className:"nTalk-window-offLine-logo-header",style:"width:"+24*this.fontSize+"px;height:"+24*this.fontSize+"px;border:none;overflow:hidden;border-radius:100%;float:left;",src:icon}).appendTo(this.offlineChatLogo);this.headerName=$({tag:"div",className:"nTalk-window-offLine-logo-name",style:"width:auto;height:"+30*this.fontSize+"px;float:left;overflow:hidden;font-size:"+16*this.fontSize+"px;line-height:"+30*this.fontSize+"px;font-weight:blod;background:transparent;color:#2c2c2c;"}).appendTo(this.offlineChat);this.headerClose=$({tag:"div",className:"nTalk-window-offLine-logo-close",style:"width:"+12*this.fontSize+"px;height:"+12*this.fontSize+"px;float:right;overflow:hidden;background:url("+$.sourceURI+"images/close.png) no-repeat;background-size:100%;margin-right:0px;margin-top:0px;"}).appendTo(this.offlineChatLogo);this.offlineChatContainer=$({tag:"div",className:"nTalk-window-offline-container",style:"width:100%;height:"+30*this.fontSize+"px;flot:left;positon:relative;overflow:hidden;background:transparent;"}).appendTo(this.offlineChat);this.offlineChatMessage=$({tag:"div",className:"nTalk-window-offline-message",style:"width:100%;height:"+24*this.fontSize+"px;font-size:"+16*this.fontSize+"px;line-height:"+24*this.fontSize+"px;margin:0;padding:0 ;color:#2c2c2c;white-space:nowrap; overflow:hidden; text-overflow:ellipsis;box-sizing:border-box;"}).appendTo(this.offlineChatContainer);this.offlineChatBottom=$({tag:"div",className:"nTalk-window-offLine-bottom",style:"width:100%;height:"+38*this.fontSize+"px;position:fixed;bottom:0;left:0;background:#007aff;text-align:center;justify-content:center;display:flex;padding:0;margin:0;z-index:10000;"}).appendTo(true);this.offineChatBottomMsg=$({tag:"span",style:"font-size:"+16*this.fontSize+"px;line-height:"+38*this.fontSize+"px;color:#fff;display:inline-block;height:100%;vertical-align: middle;background:url("+$.sourceURI+"images/inviteidicon.png) no-repeat 0 "+13*this.fontSize+"px;background-size:"+17*this.fontSize+"px "+16*this.fontSize+"px;padding-left:"+20*this.fontSize+"px;"}).appendTo(this.offlineChatBottom).html("来和我聊天吧");this.offlineChatCount=$({tag:"div",className:"nTalk-window-offline-count",style:"width:"+20*this.fontSize+"px;height:"+20*this.fontSize+"px;position:absolute;right:"+10*this.fontSize+"px;top:-"+10*this.fontSize+"px;font-size:"+12*this.fontSize+"px;line-height:"+20*this.fontSize+"px;background:#ff3b30;color:#fff;text-align:center;border-radius:100%;"}).appendTo(this.offlineChatBottom).html(++this.count);this.headerName.html();this._bind()},receiveMessage:function(message,boolean,json){this.offlineChat.css("display","block");
this.offlineChatBottom.css("display","flex");if(message&&typeof message=="string"){this.count=this.count+1;this.offlineChatMessage.html(message);this.offlineChatCount.css("display","block").html(this.count)}if(json&&json.logo){if(this.headerLogo.attr("src")!=json.logo){this.headerLogo.attr("src",json.logo)}}if(json&&json.name){this.headerName.html(json.name)}},_bind:function(){var self=this;this.offlineChat.bind("click",function(){if(self.wid){$.im_openInPageChat("","",self.wid,{edu_inviteid:self.inviteid,edu_visitid:self.visitid})}else if(self.wid1){$.im_openInPageChat("","",self.wid1)}$._showMobileInPageWindow();self.count=0;self.offlineChatCount.css("display","none")});this.offlineChatBottom.bind("click",function(){$._showMobileInPageWindow();if($.chatViewport){$.chatViewport()}$.global.showOffline=false;if($(".ntalk-mobile-inpage-window").length==0){$.im_openInPageChat("","",self.wid)}});this.headerClose.bind("click",function(event){var event=$.Event.fixEvent(event);event.preventDefault();event.stopPropagation();self.offlineChat.css("display","none");self.offlineChatCount.css("display","block !important");try{$.chatManage.view._callEndSession(true,false);$.chatManage.closeChat(self.wid||self.wid1)}catch(e){$.Log("edu chat is already end")}})}}})(nTalk);